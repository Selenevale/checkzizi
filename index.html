<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ä»Šå¤©æ‰“å¡äº†å˜›</title>
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <style>
    body { font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif; margin:0; background:#fff; color:#222;}
    #mainApp { min-height:100vh; background:#fff; padding-bottom:56px; }

:root {
  /* â€”â€” Day ä¸»é¢˜ï¼ˆé»˜è®¤ï¼‰â€”â€” */
  --A-card-back: #f4b3c2;         /* Aå¡èƒŒ/è£…é¥°ä¸»è‰²ï¼ˆå¯é€‰ï¼‰ */
  --B-card-back: #e3eb98;
  --P-card-back: #5cb3cc;

  --A-cal-bg: rgba(244,179,194,0.27);
  --B-cal-bg: rgba(227,235,152,0.27);
  --P-cal-bg: rgba(92,179,204,0.16);

  --A-dot: rgb(244,179,194);
  --B-dot: rgb(227,235,152);
  --P-dot: rgb(92,179,204);

  --app-bg: #fff;
  --app-fg: #222;
  --panel-bg: #fafbfc;
  --panel-border: #eee;
}

[data-theme="night"]{
  /* â€”â€” Night ä¸»é¢˜ï¼ˆé»˜è®¤å€¼å…ˆç»™å‡ºä¸€å¥—æŸ”å’Œå¤œè‰²ï¼Œå¯åœ¨UIé‡Œæ”¹ï¼‰â€”â€” */
  --A-card-back: #c98a98;
  --B-card-back: #aeb86e;
  --P-card-back: #4b8fa3;

  --A-cal-bg: rgba(201,138,152,0.35);
  --B-cal-bg: rgba(174,184,110,0.35);
  --P-cal-bg: rgba(75,143,163,0.25);

  --A-dot: #c98a98;
  --B-dot: #aeb86e;
  --P-dot: #4b8fa3;

  --app-bg: #141414;
  --app-fg: #eaeaea;
  --panel-bg: #1b1b1b;
  --panel-border: #2a2a2a;
}

/* åº”ç”¨å…¨å±€åº•è‰²/å‰æ™¯ */
body, #mainApp { background: var(--app-bg); color: var(--app-fg); }

/* ç»Ÿè®¡é¢æ¿/ä¸€èˆ¬å¡ç‰‡åº•è‰²è·Ÿéšä¸»é¢˜ */
.stat-panel { background: var(--panel-bg); border-color: var(--panel-border); }
.pool-block{ background: var(--panel-bg); }

    /* TabBar */
    .tabbar { position:fixed; bottom:0; left:0; right:0; height:56px; background:#faf7fa; border-top:1px solid #eee; display:flex; z-index:30;}
    .tab-btn { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:15px; color:#aaa; cursor:pointer; font-weight:500;}
    .tab-btn.active { color:#888;}
    .tab-btn .icon { font-size:20px; margin-bottom:2px;}

    /* å†…å®¹åŒº */
    .view-page { display:none; }
    .view-page.active { display:block; }

    /* æœˆå†ï¼ˆä¸»è¦æ›´æ–°ï¼šæ ¼å­å˜æ­£æ–¹ï¼Œå»çº¢è¾¹ï¼‰ */
    .calendar-header { 
  display:flex; 
  align-items:center; 
  justify-content:center; /* æ”¹ä¸º center */
  margin:16px 10px 4px 10px;
  position: relative; /* âœ… æ–°å¢ï¼šä¸ºç»å¯¹å®šä½çš„å­å…ƒç´ æä¾›åŸºå‡† */
  height: 30px; /* âœ… æ–°å¢ï¼šç»™ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ */
}

/* --- æ–°å¢ä¸‹é¢è¿™äº›æ ·å¼ --- */
.calendar-header-left {
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
}
.calendar-header-right {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  display: flex; /* è®©ä¸¤ä¸ªç®­å¤´æŒ‰é’®å¹¶æ’ */
}
.calendar-title { 
  font-size:1.3em; 
  font-weight:600;
  /* margin: 0 auto;  å¯é€‰ï¼Œjustify-content:center å·²ç»èƒ½å¤„ç† */
}
    .calendar-title { font-size:1.3em; font-weight:600;}
    .calendar-switch {font-size:15px; color:#888; background:none; border:none; padding:4px 7px; border-radius:6px; cursor:pointer;}
    .calendar-switch.active { color:#FF6600;}
    .calendar-table { width:100%; border-spacing:6px 10px;}
    .calendar-table th { font-weight:normal; color:#444; font-size:14px; padding:2px 0;}
    .calendar-day {
  width: 13vw;
  height: 13vw;
  min-width: 28px;
  min-height: 28px;
  max-width: 44px;
  max-height: 44px;
  /* å…¶ä»–ä¸å˜ */
  background: #fff;
  border-radius: 32%;
  box-shadow: 0 1px 3px rgba(0,0,0,0.03);
  text-align:left;
  vertical-align:top;
  position:relative;
  font-size:14px;
  cursor:pointer;
  transition: box-shadow .10s;
  border: none;
  /* ç§»é™¤äº†todayçº¢è¾¹ç­‰æ‰€æœ‰border */
}
    /* ä¸å†åŒºåˆ†todayçº¢è‰²è¾¹ */
    /* .calendar-day.today { border:1.6px solid #ff6600;} */
    .calendar-day .day-num {
  font-size: 10px;
  position: absolute;
  top: 13%;
  left: 13%;
  font-weight: 600;
  color: #555;
}
.calendar-day .day-emoji {
  position: absolute;
  left: 50%;
  top: 52%;
  transform: translate(-50%, -50%);
  font-size: 1.12em;
  pointer-events: none;
}
.calendar-day .day-score {
  position: absolute;
  bottom: 8%;
  right: 11%;
  font-size: 10px;
  color: #FF3333;
  font-weight: bold;
}
    .calendar-day.disable {background:#f7f7f7; color:#bbb;}
    .calendar-day.A { background: rgba(244,179,194,0.27);}
    .calendar-day.B { background: rgba(227,235,152,0.27);}
    .calendar-day.P { background: rgba(92,179,204,0.16);}

    /* å¹´å† */
    .year-header { display:flex; align-items:center; justify-content:space-between; margin:16px 10px 6px 10px;}
    .year-title { font-size:1.2em; font-weight:600;}
    .year-calendar { display: flex; flex-wrap: wrap; gap: 8px 0; justify-content: flex-start; padding: 0 2px; }
    .month-block { flex: 0 0 33.3%; padding: 2px 0 2px 0; box-sizing: border-box; cursor:pointer;}
    .month-title { text-align:center; font-weight:600; font-size:16px; margin-bottom:1px; color:#222;}
    .days-table { border-spacing: 1px; width:100%; table-layout:fixed;}
    .day-dot { display:inline-block; width:6px; height:6px; border-radius:50%; border:1.2px solid #ddd; margin:0 1px; background:#fff;}
    .day-dot.filled.pink  { background: var(--A-dot); border-color: var(--A-dot); }
.day-dot.filled.green { background: var(--B-dot); border-color: var(--B-dot); }
.day-dot.filled.blue  { background: var(--P-dot); border-color: var(--P-dot); }
    .day-dot.empty { background: #fff; border-color: #ddd;}
    .days-table td { padding: 2px; height:14px; text-align:center;}
    .year-nav-btn {font-size:19px; color:#888; border:none; background:none; padding:4px 10px; cursor:pointer; border-radius:6px;}
    .year-nav-btn:active {color:#ff6600;}

    /* æ‰“å¡é¡µ */
    .punch-main {
  padding: 18px 1vw 1vw 6vw;   /* å·¦å³1vwï¼Œå¤§çº¦å±å¹•å®½åº¦1%ï¼Œè‡ªé€‚åº”ç•™ç™½ */
  max-width: 540px;             /* å±…ä¸­å®½åº¦é™åˆ¶ï¼Œé¿å…ä¸¤è¾¹å¤ªå¤§ */
  margin: 0 auto;
}

    /* emojiæ¨ªæ»‘ä¼˜åŒ– */
	 .emoji-title{ margin-top:6px; } /* é¡¶éƒ¨ç•™ç™½ï¼Œä¸é¡¶åˆ°å±å¹•è¾¹ */
    .emoji-title {font-size: 1.1em; font-weight: bold; margin-bottom: 8px;}
    .emoji-scroll-row {
      display: flex; flex-direction: row; gap: 10px;
      overflow-x: auto; /* æ¨ªå‘æ»šåŠ¨ */
      scrollbar-width: none; /* éšè—æ»šåŠ¨æ¡ï¼Œå…¼å®¹éƒ¨åˆ†æµè§ˆå™¨ */
      -ms-overflow-style: none;
      margin-bottom: 28px; margin-top: 4px;
      padding-bottom: 4px;
    }
    .emoji-scroll-row::-webkit-scrollbar { display: none; }
    .emoji-btn { font-size: 26px; width: 40px; height: 40px; border-radius: 8px;
      text-align: center; cursor: pointer; user-select:none;
      transition: background 0.16s, box-shadow 0.13s;
      box-shadow: none; background: none; border: none; outline: none;
      flex: 0 0 auto; /* ä¸è‡ªåŠ¨æ¢è¡Œ */
    }
    .emoji-btn.selected { background: #f3f3f3; box-shadow: 0 0 0 2px #ccc inset; }
	 .emoji-btn.add {
  background: #f7f7f7 !important;
  color: #ff7700 !important;
  border: 1.2px dashed #ffa24c !important;
  font-size: 24px !important;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
}

.emoji-btn.add:active {
  background: #ffe9ce !important;
}
	 .emoji-row {
  margin-bottom: 24px !important;
}
/* æ™ƒåŠ¨åŠ¨ç”» */
@keyframes shake {
  0% { transform: rotate(-7deg);}
  25% { transform: rotate(7deg);}
  50% { transform: rotate(-7deg);}
  75% { transform: rotate(7deg);}
  100% { transform: rotate(-7deg);}
}
.emoji-btn.shake {
  animation: shake 0.4s infinite linear;
  position: relative;
}

/* åˆ é™¤æŒ‰é’® */
.emoji-delete-btn {
  display: none;
  position: absolute;
  top: -8px; right: -8px;
  width: 18px; height: 18px;
  background: #fff;
  border: 1px solid #ff3333;
  color: #ff3333;
  border-radius: 50%;
  font-size: 14px;
  justify-content: center;
  align-items: center;
  z-index: 2;
  cursor: pointer;
}
.emoji-btn.shake .emoji-delete-btn {
  display: flex;
}
.emoji-btn {
  user-select: none;
  -webkit-user-select: none;
  outline: none !important;
}
.emoji-btn:focus { outline: none !important; }

    .check-title { display: flex; align-items: center; justify-content: space-between;
      font-size:1.13em; font-weight: bold; margin-bottom:10px; }
    .score-bar { color: #FF3333; font-size: 1.28em; font-weight: bold;}
    .check-list { display: flex; flex-wrap: wrap; gap: 6px 4px; margin-bottom: 18px;}
    .check-item { position: relative; }
    .check-btn {
      min-width: 83px; height: 38px; padding: 0 13px;
      border: 1.2px solid #dddddd; background: #fff;
      color: #888; font-size: 0.97em; border-radius: 11px;
      cursor: pointer; font-weight: 500; transition: all .14s;
      position:relative; box-shadow:none; outline:none; margin-bottom: 2px;
    }
    .check-btn.selected {
      color: #ff7700; border: 1.8px solid #ff9900;
      background: #fff; font-weight: bold;
    }
    .plus-anim {
      color: #FF3333;
      position: absolute; right: 12px; top: -13px;
      font-size: 1.08em; font-weight: 700; opacity: 1;
      animation: floatUp 0.82s cubic-bezier(.37,1.22,.42,.93) forwards;
      pointer-events:none; z-index:99;
      text-shadow: 0 0 1px #fff;
    }
    @keyframes floatUp {
      0% { opacity:1; transform:translateY(0) scale(1);}
      60% { opacity:1; transform:translateY(-16px) scale(1.11);}
      100% { opacity:0; transform:translateY(-35px) scale(0.78);}
    }
    .note-title { font-size:1.1em; font-weight:bold; margin:18px 0 6px 2px;}
    .note-textarea {
      width: 96%; max-width: 510px; min-width:160px;
      min-height: 62px; font-size: 1em; border-radius: 7px;
      border:1.2px solid #ddd; padding: 10px 10px;
      margin-bottom: 12px; box-sizing: border-box;
      resize: vertical; outline: none;
    }
    .submit-btn{
  display: block;
  margin: 12px auto 0;       /* å±…ä¸­ */
  font-size: 1em;
  color: #fff;
  background: #ff6600;
  border: none;
  border-radius: 8px;
  padding: 8px 26px;
  cursor: pointer;
  font-weight: bold;
  transition: background .16s;
}
	 .submit-btn:active{ background:#ff2600; }
	 /* --- æ–°å¢è¿™ä¸ªæ ·å¼ï¼Œç”¨äºæ‰“å¡é¡µçš„åˆ†åŒºå¡ç‰‡ --- */
.punch-section-card {
  background-color: var(--panel-bg); /* ä½¿ç”¨CSSå˜é‡ï¼Œè¿™æ ·å¤œé—´æ¨¡å¼ä¹Ÿèƒ½è‡ªåŠ¨å˜è‰² */
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px; /* å¡ç‰‡ä¹‹é—´çš„å‚ç›´é—´è· */
  border: 1px solid var(--panel-border); /* åŒæ ·ä½¿ç”¨å˜é‡ï¼Œå’Œä¸»é¢˜ä¿æŒä¸€è‡´ */
}
    .submit-tip{
  font-size: 0.96em;
  color: #FF3333;
  font-weight: bold;
  text-align: center;         /* å±…ä¸­ */
  margin-top: 8px;            /* ä¸å†ç”¨ margin-left */
  animation: tipFade 2.4s;
}
.submit-row{ margin-top: 6px; }
    @keyframes tipFade {
      0%{opacity:0;} 18%{opacity:1;} 92%{opacity:1;} 100%{opacity:0;}
    }

    /* å¥–æƒ©æŠ½å¡æ± ï¼ˆç•¥ï¼‰ */
    .reward-main {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start; 
  padding-top: 15vh;
  min-height: 85vh; /* ä¿æŒè§†å£é«˜åº¦ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´ */
  box-sizing: border-box; 
  background: var(--app-bg);
}

.card-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 18px;
  margin-bottom: 28px;
  min-height: 430px; /* è°ƒå¤§æœ€å°é«˜åº¦ä»¥å®¹çº³å¤§å¡ç‰‡ */
  align-items: center;
}

/* æ›¿æ¢è¿™ä¸ªæ ·å¼ */
.card-back, .card-front-img {
  width: 300px;  /* 120px * 2.5 */
  height: 425px; /* 170px * 2.5 */
  border-radius: 24px; /* åœ†è§’ä¹Ÿå¯ä»¥ç¨å¾®å¤§ä¸€ç‚¹ï¼Œæ›´åè°ƒ */
  background: #eee;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08); /* é˜´å½±ä¹ŸåŠ å¼ºä¸€ç‚¹ */
  transition: transform .7s cubic-bezier(.66,-0.03,.3,1.18), opacity .5s, box-shadow .2s;
  cursor: default; /* å› ä¸ºæ˜¯é æŒ‰é’®æŠ½ï¼Œå¡ç‰‡æœ¬èº«ä¸å¯ç‚¹ */
  position: relative;
  overflow: hidden;
  border: none;
  padding: 0;
  background-size: cover;
  background-position: center;
}
    .card-back.hide { opacity: 0; pointer-events: none; }
    .card-back.flipped, .card-front-img.flipped {
      transform: rotateY(180deg) scale(1.1);
      z-index: 11;
      box-shadow: 0 8px 32px #bba7f9cc;
    }
    .result-panel {
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  width: 100%;
  margin-top: 14px; 
  gap: 10px;

  /* --- å…³é”®æ–°å¢ï¼ --- */
  position: relative; /* åˆ›å»ºä¸€ä¸ªæ–°çš„å®šä½ä¸Šä¸‹æ–‡ */
  z-index: 10;      /* ç»™ä¸€ä¸ªæ¯”å¼¹å¹•ç‰¹æ•ˆå±‚æ›´é«˜çš„å±‚çº§ */
}
    .card-front-img {
      width: 160px; height: 220px; min-width: 160px; border-radius: 18px;
      box-shadow: 0 6px 32px #bba7f9cc;
      background-size: cover; background-position: center;
      margin-bottom: 0;
      margin-top: 0;
      background: #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 5em;
    }
    .desc-area {
      width: 95vw; max-width: 380px; margin: 0 auto;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding-top: 10px;
    }
    .reward-title {
      font-weight: bold; font-size: 1.2em; margin-bottom: 10px; color: #ea447a;
      letter-spacing: 2px; margin-top: 16px;
    }
    .reward-content {
      font-size: 1em; color: #222; margin-bottom: 12px;
    }
    .reward-tips {
      font-size: 1.13em; color: #4a90e2; margin-top: 14px;
      border-top: 1px dashed #f0bada; padding-top: 10px;
      font-style: italic;
      margin-bottom: 6px;
    }
/* --- æ–°å¢ï¼šæŠ½å¡ç»“æœå¼¹çª—æ ·å¼ --- */
.reward-popup-overlay {
  position: fixed; /* å›ºå®šåœ¨å±å¹•ä¸Š */
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  // background: rgba(0, 0, 0, 0.55); /* è¿™æ˜¯åŠé€æ˜çš„èƒŒæ™¯é®ç½©ï¼Œè®©å½©è‰²å¡ç‰‡æ›´çªå‡º */
  display: none; /* é»˜è®¤éšè— */
  align-items: center;
  justify-content: center;
  z-index: 1000; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}
    .draw-btn {
  font-size: 1.8em; /* æ”¾å¤§å›¾æ ‡ï¼Œè®©å®ƒæˆä¸ºè§†è§‰ç„¦ç‚¹ */
  background: transparent;
  color: #aaa;
  
  /* --- å…³é”®ï¼šå®šä¹‰ä¸€ä¸ªæ­£åœ† --- */
  width: 72px;
  height: 72px;
  border-radius: 50%; /* å˜æˆå®Œç¾çš„åœ†å½¢ */
  padding: 0;         /* ä¸éœ€è¦å†…è¾¹è·äº† */
  line-height: 72px;  /* å‚ç›´å±…ä¸­å›¾æ ‡ */
  text-align: center; /* æ°´å¹³å±…ä¸­å›¾æ ‡ */
  
  border: 2px solid #eee;
  margin: 18px 0 10px;
  box-shadow: none;
  cursor: pointer;
  transition: 0.2s;
  
  /* ä¸ºäº†é˜²æ­¢æŸäº›ç³»ç»Ÿå›¾æ ‡æœ‰è‡ªå¸¦çš„å­—ä½“ï¼Œæˆ‘ä»¬è¿™é‡Œä¸å¼ºåˆ¶åŠ ç²— */
  font-weight: normal; 
  /* ä¹Ÿå»æ‰å­—æ¯é—´è· */
  letter-spacing: normal;
}

.draw-btn:active {
  background: #f5f5f5;
  border-color: #ddd;
  transform: scale(0.95); /* æŒ‰ä¸‹æ—¶å¢åŠ ä¸€ä¸ªç¼©å°åŠ¨ç”»ï¼Œæ‰‹æ„Ÿæ›´å¥½ï¼*/
}
    @media (max-width: 700px) {
      .desc-area { max-width: 99vw; }
      .card-front-img { width: 95vw; min-width: 0; height: 34vw; font-size: 4em; }
    }
    @media (max-width:700px){
      .punch-main{padding:12px 3vw;}
      .calendar-header,.year-header{margin-left:2vw; margin-right:2vw;}
      .calendar-day{ width: 28vw; min-width: 30px; aspect-ratio: 1/1;}
    }
    @media (max-width:430px){ .calendar-day{width:24vw; min-width: 26px; aspect-ratio: 1/1;} .month-title{font-size:13px;} }
    @media (max-width:370px){ .calendar-day{width:21vw; min-width: 18px; aspect-ratio: 1/1;} }
td.calendar-day {
  width: 13vw !important;
  height: 13vw !important;
  min-width: 28px !important;
  min-height: 28px !important;
  max-width: 44px !important;
  max-height: 44px !important;
  background: #fff !important;
  border-radius: 32% !important;
  box-shadow: 0 1px 3px rgba(0,0,0,0.03) !important;
  text-align: left !important;
  vertical-align: top !important;
  position: relative !important;
  font-size: 14px !important;
  cursor: pointer !important;
  transition: box-shadow .10s !important;
  border: none !important;
  overflow: visible !important;
}

td.calendar-day .day-num {
  font-size: 10px !important;
  position: absolute !important;
  top: 13% !important;
  left: 13% !important;
  font-weight: 600 !important;
  color: #555 !important;
}

td.calendar-day .day-emoji {
  position: absolute !important;
  left: 50% !important;
  top: 52% !important;
  transform: translate(-50%, -50%) !important;
  font-size: 1.12em !important;
  pointer-events: none !important;
}

td.calendar-day .day-score {
  position: absolute !important;
  bottom: 8% !important;
  right: 11% !important;
  font-size: 10px !important;
  color: #FF3333 !important;
  font-weight: bold !important;
}
/* --- æ—¥å†ABCæ± èƒŒæ™¯ --- */
/* åŸæ¥æ˜¯ td.calendar-day.A { background: rgba(...); } */
td.calendar-day.A { background: var(--A-cal-bg) !important;}
td.calendar-day.B { background: var(--B-cal-bg) !important;}
td.calendar-day.P { background: var(--P-cal-bg) !important;}
td.calendar-day.disable {background:#f7f7f7 !important; color:#bbb !important;}

/* --- æ‰“å¡é¡µå·¦å³ç•™ç™½ --- */
.punch-main, .view-page#tab-punch > div, .view-page#tab-punch {
  padding-left: 1vw !important;
  padding-right: 1vw !important;
  box-sizing: border-box !important;
}

.item-settings-panel {
  background: #fafafa;
  border-radius: 11px;
  padding: 16px 12px 18px 12px;
  margin: 16px 0;
}
.me-section-title {
  font-size: 20px;
  font-weight: 400;
  text-align: left;
  padding-left: 10px;
  margin-bottom: 14px;
}
.item-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.item-row {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 2px;
  border-radius: 7px;
  transition: background 0.18s;
}
.item-row.selected, .item-row:focus-within {
  background: #f2f3f7;
}
.item-row input[type=checkbox] {
  margin-right: 4px;
}
.item-name {
  display: inline-block;
  min-width: 5.5em;
  max-width: 5.5em;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 2px 2px;
  font-weight: 400;
  border: none;
  background: transparent;
  flex-shrink: 0;
}
.item-score, .item-type, .item-short {
  padding: 2px 2px;
  text-align: left;
  font-weight: 400;
  border: none;
  background: transparent;
  min-width: 60px; /* è¿™é‡Œå¯ä»¥è°ƒå¤§ï¼Œä¿è¯æœ€é•¿çš„é¡¹ç›®åä¹Ÿä¸æŒ¤ */
  flex-shrink: 0;
}
.item-score, .item-type, .item-short {
  width: 44px;
  color: #555;
}
.add-btn {
  background: #ffe7d4;
  color: #fa7d00;
  border: none;
  border-radius: 7px;
  padding: 7px 20px;
  font-size: 1em;
  cursor: pointer;
  font-weight: 600;
  margin-top: 2px;
  margin-left: 6px;
  transition: background 0.18s;
}
.del-btn {
  background: none;
  color: #e73b3b;
  border: none;
  font-size: 17px;
  cursor: pointer;
  margin-left: 2px;
  opacity: 0.58;
}
.del-btn:active {
  color: #c00;
  opacity: 1;
}
/* éšè—åŸç”Ÿcheckbox */
.item-row input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  outline: none;
  width: 22px;
  height: 22px;
  margin-right: 8px;
  border: 2px solid #999; /* ç°è‰²è¾¹æ¡† */
  border-radius: 6px;
  background: #fff;
  vertical-align: middle;
  cursor: pointer;
  position: relative;
}

/* é€‰ä¸­æ—¶çš„ç°è‰²å¡«å…… */
.item-row input[type="checkbox"]:checked {
  background: #999;
  border-color: #dddddd;
}

/* é€‰ä¸­æ—¶ç”»âˆš */
.item-row input[type="checkbox"]:checked::after {
  content: '';
  display: block;
  width: 7px;
  height: 13px;
  border: solid #fff;
  border-width: 0 3px 3px 0;
  transform: rotate(45deg);
  position: absolute;
  left: 6px;
  top: 2px;
}
.bottom-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 10px;
  /* å…¶ä»–ä½ è¦çš„æ ·å¼ */
}

.total-score {
  font-size: 15px;
  color: #fa7d00;
  font-weight: 600;
  padding-left: 8px;
}
  /* æ–°çª—å¼€å§‹ */
/* ===== é¡¹ç›®è®¾ç½®éƒ¨åˆ† ===== */
.setting-panel-header {
  font-size: 28px;         /* æ”¾å¤§ */
  font-weight: 400;
  text-align: left !important; /* å¼ºåˆ¶å·¦å¯¹é½ */
  padding-left: 20px;      /* å·¦ä¾§ç•™ç‚¹è·ç¦»æ›´ç¾è§‚ */
  color: #444;
  transition: color .2s;
}
.setting-panel.active .setting-panel-header {
  color: #ff4d4f;
}
#item-list {
  width: 100%;
}
.item-row {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 2px;
  font-size: 17px;
}
.item-checkbox {
  margin-right: 4px;
}
.item-name, .item-score, .item-type, .item-short {
  border: none;
  background: transparent;
  border-radius: 2px;
  padding: 3px 5px;
  font-size: 17px;
  width: 60px;
  text-align: left;
}
.item-name { width: 70px; font-weight: 600; font-size: 16px;
  color: #222;}
.item-score { width: 32px; text-align: center; }
.item-type, .item-short { width: 45px; color: #666; }
.del-btn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #888;
  margin-left: 2px;
}
.row-divider {
  height: 1px;
  background: #ececec;
  margin: 2px 0 2px 0;
}

/* ---- å¥–æ± è®¾ç½®åŒºå— ---- */
/* â€”â€” å¥–é¡¹ä¸ºâ€œå¤‡å¿˜å½•é£â€ â€”â€” */
/* ===== å¥–æ± åˆ—è¡¨ï¼šç®€æ´æ–‡æœ¬é£ ===== */
/* å¤–å±‚å®¹å™¨ä¿æŒä½ ç°åœ¨çš„å¡ç‰‡æ„Ÿ */
.pool-block{
  background:#F7F7F7;
  border-radius:12px;
  padding:12px;
}

/* æ¯æ¡å¥–é¡¹ä¸€è¡Œå— */
.pool-card-row{
  margin:0;
  padding:0;
  font-size:17px;
}

/* æ ‡é¢˜è¡Œï¼šå·¦æ ‡é¢˜ï¼Œå³ä¾§åƒåœ¾æ¡¶ */
.card-title-row{
  display:flex;
  align-items:baseline;       /* æ ‡é¢˜ä¸ ğŸ—‘ åŒä¸€åŸºçº¿ */
  justify-content:space-between;
  padding:14px 0 6px;
}

/* å¯ç¼–è¾‘æ ‡é¢˜ï¼šé»‘ã€åŠ ç²—ã€æ— è¾¹æ¡†ã€æ— åº•è‰² */
.ed-title{
  font-size:18px;
  font-weight:700;
  color:#222;
  line-height:1.4;
  margin-right:8px;
  padding:0;
  background:transparent !important;
  border:none !important;
  box-shadow:none !important;
  outline:none;
}

/* å¯ç¼–è¾‘æ­£æ–‡ä¸¤è¡Œï¼šç°è‰²ã€å·¦å¯¹é½ã€æ— è¾¹æ¡† */
.ed-line{
  font-size:16px;
  color:#555;
  line-height:1.75;
  margin:6px 0 0;
  padding:0;
  background:transparent !important;
  border:none !important;
  box-shadow:none !important;
  outline:none;
  text-align:left;
}

/* å ä½æç¤ºï¼ˆå¦‚æœä½ æœ‰éœ€è¦ï¼‰ */
.ed-line[contenteditable="true"]:empty:before{
  content: attr(placeholder);
  color:#aaa;
}

/* åˆ†å‰²çº¿ */
.row-divider{
  height:1px;
  background:#E6E6E6;
  margin:12px 0;
  border:0;
}

/* åˆ é™¤æŒ‰é’®ä½è°ƒä¸€ç‚¹ */
.del-btn{
  background:transparent;
  border:0;
  font-size:18px;
  opacity:.65;
}
.del-btn:active{ opacity:.9; }

/* é¡¶éƒ¨ A/B/P æ ‡ç­¾æ ·å¼ä½ å·²å†™å¥½ï¼Œç•¥ */

/* è¦†ç›–æ‰æ—§çš„â€œå°ç™½æ¡† inputâ€å¤–è§‚ï¼ˆå¦‚æœè¿˜åœ¨ï¼‰ */
.item-name, .item-desc, .item-tips {
  border:none !important;
  background:transparent !important;
  padding:0 !important;
  height:auto !important;
  min-height:0 !important;
  box-shadow:none !important;
  width:100% !important;
}
/* é¡¶éƒ¨ A/B/P åˆ†æ®µåˆ‡æ¢ */
.pool-tabs{
  display:flex; gap:12px; padding:8px 4px 12px;
}
.pool-tab{
  min-width:40px; padding:6px 10px;
  border:none; border-radius:10px;
  background:#F0F0F0; color:#666; font-weight:600;
}
/* é˜ˆå€¼è¡Œæ•´ä½“ä¾ç„¶ç´§å‡‘ */
#poolPanel .threshold-row{
  display:flex;
  flex-wrap:wrap;
  gap:8px 12px;
  align-items:center;
}

/* å°ç»„å†…éƒ¨ä¸æ‹† */
#poolPanel .threshold-row .pair{
  display:inline-flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}

/* æ–‡å­—åˆ«å å›ºå®šå®½ */
#poolPanel .threshold-row .item-name{
  min-width:auto;
  max-width:none;
  margin:0;
  padding:0;
}

/* â€”â€” å…³é”®ï¼šç»™æ•°å­—è¾“å…¥ä¸€ä¸ªæ˜ç¡®å¤–è§‚ï¼ˆè¦†ç›–ä½ åŸæ¥â€œé€æ˜æ— è¾¹æ¡†â€çš„è®¾ç½®ï¼‰ â€”â€” */
#poolPanel .threshold-row .item-score{
  width:56px;                 /* éœ€è¦æ›´ç´§å¯ä»¥æ”¹ 50/48 */
  height:28px;
  line-height:28px;
  padding:0 6px;
  border:1px solid var(--panel-border) !important;
  border-radius:8px;
  background:#fff !important;
  color:#333 !important;
  text-align:center;
  box-sizing:border-box;
  -moz-appearance:textfield;   /* å»æ‰ Firefox çš„æ•°å­—ç®­å¤´ */
}
/* å»æ‰ WebKit çš„æ•°å­—ç®­å¤´ */
#poolPanel .threshold-row .item-score::-webkit-outer-spin-button,
#poolPanel .threshold-row .item-score::-webkit-inner-spin-button{
  -webkit-appearance:none; margin:0;
}
.pool-tab.active{
  background:#e74c3c10; /* è½»å¾®çº¢ç³»é«˜äº®åº• */
  color:#e74c3c;        /* ä½ çš„é€‰ä¸­çº¢ */
  box-shadow:0 1px 0 rgba(0,0,0,.05) inset;
}

/* ä¸»ä½“å¡ç‰‡å®¹å™¨ï¼ˆä¿ç•™ä½ åŸæ¥çš„å¹²å‡€é£æ ¼ï¼‰ */
.pool-block{ background:#F7F7F7; border-radius:12px; padding:12px; }
.pool-title{ font-weight:700; font-size:18px; color:#888; margin:4px 0 8px; }

/* å¥–é¡¹è¡Œï¼ˆä¿æŒä½ ç°åœ¨çš„æ ·å­ï¼›å¦‚æœä¹‹å‰æœ‰ .pool-card-row/.row-divider å°±ç»§ç»­æ²¿ç”¨ï¼‰ */

/* â€”â€” è‰²å½©è®¾ç½®æ€»å®¹å™¨ï¼ˆå•å¡åŒ…è£¹å…¨éƒ¨ï¼‰ â€”â€” */
.color-wrap{
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  border-radius: 12px;
  padding: 12px;
}

/* â€”â€” æ¯è¡Œï¼šå·¦åå­—ï¼Œå³è¾¹è‰²ç›˜+è‰²å· â€”â€” */
.color-row{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:10px 12px; border-radius:10px;
}
.color-row + .color-row{ margin-top:6px; }
.color-row .label{ font-size:15px; color: var(--app-fg); }
.color-row .inputs{ display:flex; align-items:center; gap:10px; }
.color-row input[type=color]{ width:28px; height:28px; border:none; padding:0; background:transparent; }
.color-row input[type=text]{
  width:180px; max-width:260px;
  border:1px solid var(--panel-border); border-radius:8px;
  padding:6px 8px; background:#fff; color:#333; outline:none;
}

/* â€”â€” æ‰“å¡é¡µé€‰ä¸­æ€ç”¨å˜é‡é©±åŠ¨ â€”â€” */
:root{
  --check-selected-border: #ff9900;
  --check-selected-bg: #ffffff;
  --check-selected-fg: #ff7700;
}
.check-btn.selected{
  color: var(--check-selected-fg);
  border: 1.8px solid var(--check-selected-border);
  background: var(--check-selected-bg);
  font-weight: bold;
}
/* éšè—æ± æ ‡é¢˜è¡Œ */
.pool-title{ display:none; }
/* é˜ˆå€¼è¡Œå¸ƒå±€ï¼ˆç´§å‡‘ä¸”ä¸æ¢é”™è¡Œï¼‰ */
#poolPanel .threshold-row{
  display:flex;
  align-items:center;
  gap: 10px 16px;     /* é—´è·ï¼›æƒ³æ›´ç´§å¯è°ƒæˆ 8px 12px */
  flex-wrap:wrap;     /* å°å±è‡ªåŠ¨æ¢è¡Œ */
}

/* æ–‡æ¡ˆæ ·å¼ */
#poolPanel .threshold-row .th-label{
  font-size: 15px;
  color:#333;
  white-space:nowrap;
  margin:0;
  padding:0;
}

/* æ•°å­—è¾“å…¥å¤–è§‚ï¼ˆç‹¬ç«‹äºå…¨å±€ input æ ·å¼ï¼‰ */
#poolPanel .threshold-row .th-input{
  width:56px;         /* å¤ªæŒ¤æ”¹ 50 */
  height:28px;
  padding:0 6px;
  border:1px solid var(--panel-border);
  border-radius:8px;
  background:#fff;
  color:#333;
  text-align:center;
  box-sizing:border-box;
  outline:none;
  -moz-appearance:textfield;
}
#poolPanel .threshold-row .th-input::-webkit-outer-spin-button,
#poolPanel .threshold-row .th-input::-webkit-inner-spin-button{
  -webkit-appearance:none; margin:0;
}

/* é˜²æ­¢æ—§çš„å…¨å±€ .item-name/.item-score å½±å“è¿™ä¸€è¡Œï¼ˆä¿é™©ï¼‰ */
#poolPanel .threshold-row .item-name,
#poolPanel .threshold-row .item-score{
  all: unset;         /* æ¸…ç©ºæ—§æ ·å¼ï¼Œé¿å…è¯¯ä¼¤ */
}
/* åªå½±å“â€œæˆ‘â€é¡µ */
#tab-me .add-btn,
#tab-me .add-btn-plain,
#tab-me .again-btn,
#tab-me .draw-btn,
#tab-me .submit-btn {
  background: #fff !important;   /* ç™½åº• */
  color: #4a90e2 !important;            /* ç™½å­—ï¼ˆæƒ³ç°åº•è“å­—å°±æ”¹æˆ #4a90e2ï¼‰ */
  border: none !important;
  box-shadow: none !important;
}
#tab-me .add-btn:active,
#tab-me .add-btn-plain:active,
#tab-me .again-btn:active,
#tab-me .draw-btn:active,
#tab-me .submit-btn:active {
  background: #4b5563 !important;
}
#tab-me .total-score { color:#4a90e2 !important; }
#tab-me .pool-tab.active{
  background:#6b7280 !important;
  color:#fff !important;
  box-shadow:none !important;
}
/* â€”â€” å¯¼å…¥å¯¼å‡ºä¸¤åˆ—å¯¹é½ â€”â€” */
/* ä¸¤åˆ—è¡Œï¼šå·¦ä¼¸ç¼©ï¼Œå³è´´è¾¹ */
.row-2col { display:flex; align-items:center; }
.row-2col .flex { flex:1 1 auto; min-width:0; }  /* å…³é”®ï¼šå…è®¸ç¼©å° */
.nowrap { white-space: nowrap; }
.right { margin-left: auto; }                    /* å…³é”®ï¼šæŒ‰é’®è´´å³ */
/* â€”â€” ä¸­å¤®åœ†è§’å¡ç‰‡ â€”â€” */
.reward-frame{
  width: min(85vw, 450px);
  margin: 0 auto 30px; 
  border-radius: 20px;
  padding: 20px 24px;
  background: #fff;
  box-shadow: 0 10px 30px rgba(0,0,0,.1);
  border: 1px solid var(--panel-border);
  position: relative; /* ç¡®ä¿ z-index ç”Ÿæ•ˆ */
  z-index: 10;      /* è®©å¡ç‰‡åœ¨å¼¹å¹•ä¹‹ä¸Š */
}
.reward-frame .rf-title{
  font-weight: 700;
  font-size: 20px;
  margin-bottom: 12px;
}
.reward-frame .rf-content{
  white-space: pre-wrap;
  line-height: 1.75;
  color: #333;
  font-size: 16px;
}

/* â€”â€” è·Ÿéšæ± å­é…è‰²ï¼šç”¨ä½ å·²æœ‰å˜é‡ â€”â€” */
.reward-frame.pool-A{ background: var(--A-cal-bg); }
.reward-frame.pool-B{ background: var(--B-cal-bg); }
.reward-frame.pool-P{ background: var(--P-cal-bg); }

/* â€”â€” æ•ˆæœå±‚ï¼ˆå¼¹å¹•/ä¸‹é›¨ï¼‰â€”â€” */
.fx-layer{
  position: fixed; /* æ”¹ä¸ºfixedï¼Œç›¸å¯¹äºå±å¹•å®šä½ */
  top: 0;
  left: 0;
  width: 100vw;      /* å®½åº¦å æ»¡æ•´ä¸ªå±å¹• */
  height: 100vh;     /* é«˜åº¦å æ»¡æ•´ä¸ªå±å¹• */
  overflow: hidden;
  pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€ï¼Œéå¸¸é‡è¦ï¼ */
  z-index: 5;           /* å±‚çº§è¦ä½äºç²‰è‰²å¡ç‰‡(z-index:10)ï¼Œé«˜äºé¡µé¢èƒŒæ™¯ */
}

/* â€”â€” å°é›¨æ»´ï¼ˆæ ·å¼ä¸å˜ï¼ŒåŠ¨ç”»å˜äº†ï¼‰ â€”â€” */
.drop{
  position:absolute;
  top:-20px; /* ä»å±å¹•é¡¶éƒ¨å¤–å¼€å§‹ */
  width:2px; height:10px;
  background: rgba(120,140,160,.6);
  border-radius: 2px;
  opacity:.9;
  animation: rainFall linear forwards;
}
@keyframes rainFall {
  to { transform: translateY(102vh); opacity:.15; } /* ä¸‹è½è¶…è¿‡æ•´ä¸ªå±å¹•çš„é«˜åº¦ */
}
/* ä¸ºè‡ªå®šä¹‰å›¾ç‰‡ä¸‹è½è®¾è®¡çš„æ ·å¼ */
.rain-image {
  position: absolute;
  top: -60px; /* ä»æ›´é«˜çš„åœ°æ–¹å¼€å§‹ï¼Œç»™å›¾ç‰‡åŠ è½½ç•™å‡ºæ—¶é—´ */
  width: 45px; /* å›¾ç‰‡çš„å°ºå¯¸ï¼Œæ‚¨å¯ä»¥æ ¹æ®å–œå¥½è°ƒæ•´ */
  height: 45px;
  object-fit: contain; /* ä¿è¯å›¾ç‰‡æ¯”ä¾‹æ­£ç¡® */
  pointer-events: none;
  user-select: none;
}

/* å¸¦æœ‰æ—‹è½¬é£˜è½æ•ˆæœçš„åŠ¨ç”» */
@keyframes rainFallWithFlutter {
  from {
    transform: translateY(0) rotate(0deg);
    opacity: 1;
  }
  to {
    transform: translateY(102vh) rotate(360deg); /* ä¸‹è½çš„åŒæ—¶æ—‹è½¬ä¸€å‘¨ */
    opacity: 0.15;
  }
}

/* â€”â€” å¼¹å¹•æ°”æ³¡ï¼ˆæ ·å¼ä¸å˜ï¼ŒåŠ¨ç”»å˜äº†ï¼‰ â€”â€” */
/* æ³¨æ„ï¼šè¿™é‡Œç»Ÿä¸€ä½¿ç”¨ .bullet ç±»é€‰æ‹©å™¨ */
.bullet { 
  position: absolute;
  bottom: 0; 
  transform: translateY(100%);
  
  font-size: 16px;
  color: #888; 
  pointer-events: none;
  
  /* --- å…³é”®æ”¹åŠ¨åœ¨è¿™é‡Œ --- */
  white-space: normal;      /* å…è®¸æ­£å¸¸æ¢è¡Œ */
  word-break: break-all;    /* å…è®¸åœ¨ä»»æ„å­—ç¬¦é—´æ¢è¡Œï¼Œå¤„ç†é•¿è‹±æ–‡æˆ–é“¾æ¥ */
  text-align: center;       /* æ¢è¡Œåå±…ä¸­å¯¹é½ï¼Œæ›´å¥½çœ‹ */
  max-width: 65vw;          /* é™åˆ¶æœ€å¤§å®½åº¦ä¸ºå±å¹•çš„80%ï¼Œé¿å…å¤ªå®½ */
  box-sizing: border-box;   /* ç¡®ä¿å†…è¾¹è·ç­‰ä¸ä¼šå½±å“å®½åº¦è®¡ç®— */
  
  animation: barrage-rise linear forwards;
  z-index: 5; 
}

@keyframes barrage-rise {
  from {
    transform: translateY(50px); /* ä»å±å¹•åº•éƒ¨ 50px çš„ä½ç½®å¼€å§‹ï¼Œé¿å…çªç„¶å‡ºç° */
    opacity: 0;
  }
  20% {
      opacity: 1; /* åœ¨ 20% çš„æ—¶é—´é‡Œå®Œå…¨å‡ºç° */
  }
  to {
    transform: translateY(-100vh); /* å‘ä¸Šé£˜å‡ºæ•´ä¸ªå±å¹•çš„é«˜åº¦ */
    opacity: 0; /* åœ¨ç»“å°¾å®Œå…¨æ¶ˆå¤± */
  }
}

/* --- æ–°å¢è¿™ä¸ªå®¹å™¨æ ·å¼ --- */
.popup-container {
  position: absolute; /* æ”¹ä¸ºabsoluteï¼Œå®ƒä¼šè·Ÿéšçˆ¶çº§æ»šåŠ¨ */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none; /* è®©å®ƒä¸å½±å“ä¸‹å±‚å…ƒç´ çš„ç‚¹å‡» */
  z-index: 100;
}

/* --- æ›¿æ¢è¿™ä¸ªæ°”æ³¡æ ·å¼ --- */
.year-dot-popup {
  position: absolute;
  /* æ ¸å¿ƒæ”¹åŠ¨ï¼šä½¿ç”¨rgbaè®¾ç½®å¸¦é€æ˜åº¦çš„ç™½è‰²èƒŒæ™¯ */
  background: rgba(255, 255, 255, 0.18);
  /* é¢å¤–ç¦åˆ©ï¼šå¢åŠ ä¸€ä¸ªæ¯›ç»ç’ƒæ•ˆæœï¼Œæ›´æœ‰è´¨æ„Ÿ */
  -webkit-backdrop-filter: blur(4px);
  backdrop-filter: blur(4px);
  color: #333;
  padding: 5px 10px;
  border-radius: 8px;
  font-size: 16px;
  border: 1px solid rgba(255, 255, 255, 0.25); /* è¾¹æ¡†ä¹Ÿç”¨åŠé€æ˜ç™½è‰² */
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: flex;
  gap: 2px;
  white-space: nowrap;
  /* å¢åŠ ä¸€ä¸ªå¹³æ»‘å‡ºç°çš„åŠ¨ç”» */
  transition: opacity 0.2s, transform 0.2s;
}

/* å°ä¸‰è§’çš„é¢œè‰²ä¹Ÿè¦è·Ÿç€å˜åŠé€æ˜ */
.year-dot-popup::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 6px;
  border-style: solid;
  /* æ ¸å¿ƒæ”¹åŠ¨ï¼šä¸‰è§’çš„é¢œè‰²å’Œæ°”æ³¡èƒŒæ™¯ä¿æŒä¸€è‡´ */
  border-color: rgba(255, 255, 255, 0.88) transparent transparent transparent;
}

/* --- æ–°å¢ï¼šä¼˜é›…çš„æŠ˜å å°ä¸‰è§’æ ·å¼ --- */
.chevron-arrow {
  display: inline-block;
  width: 0;
  height: 0;
  margin-left: 8px;
  vertical-align: middle; /* è®©å®ƒå’Œæ–‡å­—å‚ç›´å±…ä¸­å¯¹é½ */
  border-style: solid;
  border-width: 5px 0 5px 7px; /* ä¸Šä¸‹5px, å·¦è¾¹7pxï¼Œæ„æˆä¸€ä¸ªä¸‰è§’ */
  border-color: transparent transparent transparent #888; /* åªæœ‰å·¦è¾¹æœ‰é¢œè‰² */
  transition: transform 0.2s ease-out; /* å¹³æ»‘æ—‹è½¬åŠ¨ç”» */
  transform-origin: center; /* ç¡®ä¿ä»ä¸­å¿ƒæ—‹è½¬ */
}

/* å½“å®ƒæœ‰ä¸€ä¸ª 'active' ç±»æ—¶ï¼Œæ—‹è½¬90åº¦æœä¸‹ */
.chevron-arrow.active {
  transform: rotate(90deg);
}
  </style>
</head>
<body>
<div id="mainApp">
  <!-- æ—¥å†Tab -->
  <div class="view-page" id="tab-calendar">
    <div id="calendarBox"></div>
  </div>
  <!-- æ‰“å¡Tab -->
  <div class="view-page" id="tab-punch">
    <div id="punchBox"></div>
  </div>
  <!-- å¥–æƒ©æ± Tab -->
  <div class="view-page" id="tab-pool">
  <div class="reward-main">
    <!-- å¡ç‰‡ç¿»è½¬çš„èˆå° (ä¸å˜) -->
    <div id="cardRow" class="card-row"></div>
    <!-- æŠ½å¡æŒ‰é’®çš„å®¹å™¨ (ä¸å˜) -->
    <div id="drawBtnContainer">
      <button id="drawBtn" class="draw-btn" onclick="drawCard()">ğŸ¦â€â¬›</button>
    </div>
  </div>

  <!-- âœ… ä¿®æ”¹ï¼šæŠŠç»“æœå±•ç¤ºåŒºåšæˆä¸€ä¸ªç‹¬ç«‹çš„å¼¹çª— -->
  <div id="rewardPopup" class="reward-popup-overlay" onclick="resetDraw()">
    <div onclick="event.stopPropagation()"> <!-- é˜²æ­¢ç‚¹å‡»å¡ç‰‡ä¹Ÿå…³é—­å¼¹çª— -->
        <div id="rewardFrame" class="reward-frame" style="position:relative; z-index:10;">
          <div class="rf-title" id="rfTitle"></div>
          <div class="rf-content" id="rfContent"></div>
        </div>
        <div style="position:relative; z-index:10; margin-top:20px; text-align:center;">
          <button class="again-btn" onclick="resetDraw()">å†æŠ½ä¸€æ¬¡</button>
        </div>
    </div>
  </div>
</div>
  <!-- æˆ‘ Tab -->
<div class="view-page" id="tab-me" style="padding:48px 8px 16px 8px;text-align:center;">

  <!-- 1) é¡µé¢è®¾ç½®ï¼ˆ= ä½ åŸæ¥çš„â€œæ‰“å¡é¡¹ç›®è®¾ç½®â€ + å¯è§é¡¹ç­‰ï¼‰ -->
  <div class="setting-panel" id="meSettingsPanel">
    <div class="setting-panel-header" onclick="togglePanel('meSettingsPanel')">
      é¡µé¢è®¾ç½®
    </div>
    <div class="setting-panel-body" style="display:none;">
  <div class="item-settings-panel">
    <div id="item-list"></div>
    <div class="bottom-row" style="margin-top:10px;">
  <button class="add-btn" onclick="addNewItemRow()">+ æ–°å¢é¡¹ç›®</button>
  <div class="total-score" id="enabledTotalScore">æ€»åˆ†ï¼š0</div>
</div>
  </div>
</div>
  </div>

  <!-- 2) å¥–æ± è®¾ç½®ï¼ˆå« A/B/P æ ‡ç­¾ã€å¯ç¼–è¾‘å¡ç‰‡åˆ—è¡¨ã€åˆ†æ•°é˜ˆå€¼ï¼‰ -->
<div class="setting-panel" id="poolPanel">
  <div class="setting-panel-header" onclick="togglePanel('poolPanel')">
    å¥–æ± è®¾ç½®
  </div>
  <!-- âœ… é‡ç‚¹ï¼š#poolList å¿…é¡»åœ¨ body é‡Œé¢ï¼›åˆ æ‰å¤šä½™çš„ </div> -->
  <div class="setting-panel-body" style="display:none;">
    <!-- åˆ†æ•°é˜ˆå€¼ï¼Œæ”¾åœ¨å¥–æ± è®¾ç½®é‡Œ -->
    <div class="item-settings-panel">
      <div class="item-row threshold-row">
        <label class="th-label">Aæ¡£ â‰¥</label>
        <input class="th-input" type="number" id="thA" oninput="saveThresholds()">
        <label class="th-label">Bæ¡£ â‰¥</label>
        <input class="th-input" type="number" id="thB" oninput="saveThresholds()">
        <span class="th-label">Pæ¡£ï¼šä½äº B</span>
      </div>
    </div>

    <!-- âœ… è¿™é‡Œæ˜¯æ¸²æŸ“å®¹å™¨ï¼Œå¿…é¡»ç•™åœ¨ body é‡Œ -->
    <div id="poolList"></div>
  </div>
</div>

  <!-- 3) è‰²å½©ä¸»é¢˜ -->
  <div class="setting-panel" id="colorPanel">
  <div class="setting-panel-header" onclick="togglePanel('colorPanel')">
    è‰²å½©ä¸»é¢˜
  </div>
  <div class="setting-panel-body" style="display:none; text-align:left; padding:12px;">
    <div style="margin:0 8px 12px; font-size:14px; color:#888;">
      ç›´æ¥ç¼–è¾‘ä»¥ä¸‹é¢œè‰²ï¼ˆ#RRGGBB / rgbaï¼‰ã€‚A/B/P ä¸æ‰“å¡é€‰ä¸­æ€å³æ—¶ç”Ÿæ•ˆã€‚
    </div>
    <div id="colorList"></div>
    <div class="bottom-row" style="margin-top:14px;">
      <button class="add-btn" onclick="resetThemeToDefault()">æ¢å¤é»˜è®¤</button>
      <div class="total-score">æ”¹å®Œå³ç”Ÿæ•ˆå¹¶ä¿å­˜</div>
    </div>
  </div>
</div>

  <!-- 4) å¯¼å…¥ / å¯¼å‡º -->
<div class="setting-panel" id="ioPanel">
  <div class="setting-panel-header" onclick="togglePanel('ioPanel')">
    å¯¼å…¥ / å¯¼å‡º
  </div>

  <div class="setting-panel-body" style="display:none; text-align:left; padding:12px;">

    <!-- å¯†ç è®¾ç½® -->
    <div class="item-settings-panel">
      <div class="me-section-title">å¯†ç è®¾ç½®</div>
      <div class="item-row row-2col">
  <div class="flex">
    <input class="item-name" id="pwdInput" placeholder="è®¾ç½®æˆ–æ›´æ–°å¯†ç " type="password" style="min-width:200px;">
  </div>
  <button class="add-btn nowrap right" onclick="setIoPassword()">ä¿å­˜å¯†ç </button>
</div>
      <div style="font-size:12px;color:#888;padding-left:10px;">
        ä»…ç”¨äºå¯¼å…¥/å¯¼å‡ºæ—¶æ ¡éªŒï¼›æœ¬åœ°ä¿å­˜å“ˆå¸Œã€‚
      </div>
    </div>

    <!-- æ•°æ®å¯¼å‡º -->
    <div class="item-settings-panel">
      <div class="me-section-title">æ•°æ®å¯¼å‡º</div>
      <div class="item-row row-2col">
        <button class="add-btn" onclick="exportAll()">å¯¼å‡ºåˆ°æ–‡ä»¶</button>
        <div class="flex"></div>
        <button class="add-btn" onclick="copyAll()">å¤åˆ¶æ•°æ®</button>
      </div>
    </div>

    <!-- æ•°æ®å¯¼å…¥ -->
    <div class="item-settings-panel">
      <div class="me-section-title">æ•°æ®å¯¼å…¥</div>
      <div class="item-row row-2col">
  <div class="flex">
    <input type="file" id="importFile" accept=".json" onchange="importAll()">
  </div>
  <button class="add-btn nowrap right" onclick="importFromClipboard()">ä»å‰ªè´´æ¿å¯¼å…¥</button>
</div>
      <div style="font-size:12px;color:#888;padding-left:10px;">
        å¯¼å…¥ä¼šè¦†ç›–åŒåæ•°æ®ï¼Œæ‰§è¡Œå‰ä¼šå¼¹çª—è¦æ±‚è¾“å…¥å¯†ç ã€‚
      </div>

      <!-- æ¸…ç©ºæ•°æ®æŒ‰é’®ï¼ˆæµ‹è¯•ç”¨ï¼‰ -->
      <button onclick="clearAllData()" style="background:#ccc;color:#000;padding:6px 12px;border:none;border-radius:4px;margin-top:8px;">
        æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆæµ‹è¯•ç”¨ï¼‰
      </button>
    </div>

  </div>
</div>
 
</div>

<div id="fxLayer" class="fx-layer" style="display: none;"></div>

<!-- TabBar (ä¿®æ”¹å) -->
<div class="tabbar" id="tabBar">
  <div class="tab-btn" data-tab="calendar">
    <div class="icon">
      <!-- æŠŠä½ çš„æ—¥å†SVGä»£ç ç²˜è´´åœ¨è¿™é‡Œ -->	
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <title>æ—¥å†</title>
        <path d="M4 7C4 6.44772 4.44772 6 5 6H19C19.5523 6 20 6.44772 20 7V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19V7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M16 4V8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M8 4V8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M4 10H20" stroke="currentColor" stroke-width="2"/>
      </svg>
    </div>
  </div>
  <div class="tab-btn" data-tab="punch">
    <div class="icon">
      <!-- æŠŠä½ çš„æ‰“å¡SVGä»£ç ç²˜è´´åœ¨è¿™é‡Œ -->
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <title>æ‰“å¡</title>
        <path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>
  <div class="tab-btn" data-tab="pool">
    <div class="icon">
      <!-- æŠŠä½ çš„å¥–æ± SVGä»£ç ç²˜è´´åœ¨è¿™é‡Œ -->
       <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <title>å¥–æ± </title>
        <path d="M20.84 4.61C20.3292 4.09902 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 3C15.76 3 14.63 3.49 13.84 4.29L12 6.13L10.16 4.29C9.37 3.49 8.24 3 7.05 3C6.32754 2.99817 5.6121 3.14052 4.94464 3.41708C4.27718 3.69364 3.67081 4.09902 3.16 4.61C1.22 6.55 1.43 9.71 4.04 12.33L12 20.29L19.96 12.33C22.57 9.71 22.78 6.55 20.84 4.61Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>
  <div class="tab-btn" data-tab="me">
    <div class="icon">
      <!-- æŠŠä½ çš„â€œæˆ‘â€SVGä»£ç ç²˜è´´åœ¨è¿™é‡Œ -->
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <title>æˆ‘</title>
        <path d="M20 21V19C20 16.7909 18.2091 15 16 15H8C5.79086 15 4 16.7909 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>
</div>
<script>
window.onerror = function(msg, src, line, col, err) {
  alert('JS Error: ' + msg + '\n' + src + ':' + line + ':' + col);
};
// â€”â€” é¢„å£°æ˜ï¼ŒæŒ¡ä½ TDZ â€”â€”  (æ”¾åœ¨ window.onerror ä¸‹é¢)
let punchItems = [];
let poolData = {};
let poolThresholds = { A:48, B:34 };
let visibleItems = [];
let theme = null;
let ioPasswordHash = '';
/* --------- æ•°æ®å®šä¹‰ ----------- */
const punchItemsRaw = [
  {name:"ç¤ºä¾‹é¡¹ç›®1", score:1}, 
  {name:"ç¤ºä¾‹é¡¹ç›®2", score:2}
];
// ç”¨äºè®°å½•å½“å‰å¯è§é¡¹ç›®ï¼ˆå¯¹â€œå¯ç”¨é¡¹â€çš„ç´¢å¼•ï¼Œé»˜è®¤å…¨é€‰ï¼‰
try{
  visibleItems = JSON.parse(localStorage.getItem('visibleItems'));
  if(!Array.isArray(visibleItems)) throw new Error();
}catch{
  // é»˜è®¤å…¨é€‰ï¼šåŸºäºå½“å‰å¯ç”¨é¡¹
  const act = getActiveItems();
  visibleItems = act.map((_, idx)=>idx);
  localStorage.setItem('visibleItems', JSON.stringify(visibleItems));
}
// emojiè¡¨æƒ…
let emojiList = [];
try {
    const storedEmojis = localStorage.getItem('emojiList');
    if (storedEmojis) {
        emojiList = JSON.parse(storedEmojis);
    }
    if (!Array.isArray(emojiList) || emojiList.length === 0) {
        // å¦‚æœå­˜å‚¨æ˜¯ç©ºçš„æˆ–æ— æ•ˆçš„ï¼Œå°±ä½¿ç”¨é»˜è®¤å€¼
        emojiList = ["ğŸ˜ƒ","ğŸ˜†","ğŸ¥²","ğŸ™ƒ","ğŸ˜‡","ğŸ¥°","ğŸ™„","ğŸ¥³","ğŸ˜”","ğŸ˜¤","ğŸ˜‘","ğŸ¥±","ğŸ¤¡","ğŸ¤’","ğŸ–•","ğŸ©¸"];
        localStorage.setItem('emojiList', JSON.stringify(emojiList));
    }
} catch (e) {
    // å¦‚æœè§£æå‡ºé”™ï¼Œä¹Ÿä½¿ç”¨é»˜è®¤å€¼
    emojiList = ["ğŸ˜ƒ","ğŸ˜†","ğŸ¥²","ğŸ™ƒ","ğŸ˜‡","ğŸ¥°","ğŸ™„","ğŸ¥³","ğŸ˜”","ğŸ˜¤","ğŸ˜‘","ğŸ¥±","ğŸ¤¡","ğŸ¤’","ğŸ–•","ğŸ©¸"];
}
// æ•°æ®ç»“æ„ punchLog[year][month][day] = {score, emojis:[], checked:[], note:""}
let punchLog = {};
try{
  let raw = localStorage.getItem('isla_punchLog');
  if(raw) punchLog = JSON.parse(raw)||{};
}catch(e){ punchLog = {}; }

// ========== é¡¹ç›®è®¾ç½®å¯ç¼–è¾‘ç‰ˆ ==========
punchItems = [];
function loadItems() {
  let data = localStorage.getItem('punchItems');
  if (data) {
    try { 
      punchItems = JSON.parse(data); 
      if (!Array.isArray(punchItems) || punchItems.length === 0) {
        throw new Error("Invalid or empty items");
      }
    } catch {
      // å¦‚æœæœ¬åœ°æ•°æ®æœ‰é—®é¢˜ï¼Œä¹Ÿç”¨é»˜è®¤å€¼è¦†ç›–
      punchItems = JSON.parse(JSON.stringify(punchItemsRaw)).map(item => ({ ...item, show: true }));
    }
  } else {
    // å¦‚æœæœ¬åœ°å­˜å‚¨å®Œå…¨æ²¡æœ‰ï¼Œä½¿ç”¨é»˜è®¤å€¼åˆå§‹åŒ–
    punchItems = JSON.parse(JSON.stringify(punchItemsRaw)).map(item => ({ ...item, show: true }));
  }
}
function computeEnabledTotalScore(){
  loadItems();
  let sum = 0;
  (punchItems||[]).forEach(it=>{
    if (it?.show !== false) sum += Number(it?.score||0);
  });
  return sum;
}
function updateEnabledTotalScoreUI(){
  const el = document.getElementById('enabledTotalScore');
  if (!el) return;
  el.textContent = 'æ€»åˆ†ï¼š' + computeEnabledTotalScore();
}

function saveItems() {
  localStorage.setItem('punchItems', JSON.stringify(punchItems));
}

// å½“å‰å¯ç”¨ï¼ˆshow!==falseï¼‰çš„é¡¹ç›®æ¸…å• + ä¸€è‡´æ’åºï¼ˆtypeç›¸é‚»ï¼Œå†æŒ‰nameï¼‰
function getActiveItems(){
  loadItems();
  let list = (punchItems||[]).filter(it => it?.show !== false);
  list.sort((a,b)=>{
    const ta = String(a.type||'').localeCompare(String(b.type||''));
    if(ta!==0) return ta;
    return String(a.name||'').localeCompare(String(b.name||''));
  });
  return list;
}
// æ˜¾ç¤ºçŸ­åï¼šä¼˜å…ˆ shortï¼Œå…¶æ¬¡nameæˆªæ–­
function getShortLabel(it){
  if(it?.short && String(it.short).trim()) return it.short.trim();
  const nm = String(it?.name||'');
  return nm.length>4 ? nm.slice(0,4)+'â€¦' : nm;
}

function shortText(text, maxLen = 5) {
  return text.length > maxLen ? text.slice(0, maxLen) + 'â€¦' : text;
}
function renderItemSettings() {
  loadItems();
  const container = document.getElementById('item-list');
  let html = '';
  (punchItems||[]).forEach((item, idx) => {
    html += `
      <div class="item-row">
        <input type="checkbox" class="item-checkbox" ${item.show !== false ? 'checked' : ''} onchange="editItemCell(${idx},'show',this.checked)">
        <input class="item-name" value="${escapeHtml(item.name||'')}" maxlength="8"
       oninput="editItemCellLive(${idx},'name',this.value)"
       onblur="commitItemCell(${idx},'name',this.value)">
        <input class="item-score" type="number" value="${escapeHtml(String(item.score??1))}" oninput="editItemCell(${idx},'score',this.value)">
        <input class="item-type" value="${escapeHtml(item.type||'')}"
       oninput="editItemCellLive(${idx},'type',this.value)"
       onblur="commitItemCell(${idx},'type',this.value)">
        <input class="item-short" value="${escapeHtml(item.short||'')}" oninput="editItemCell(${idx},'short',this.value)">
        <button class="del-btn" onclick="deleteItem(${idx})" title="åˆ é™¤">ğŸ—‘ï¸</button>
      </div>
      <div class="row-divider"></div>
    `;
  });
  container.innerHTML = html;
  updateEnabledTotalScoreUI();
}
// ---- è®©é¡µé¢è®¾ç½®å¯ç¼–è¾‘ï¼šæ ¸å¿ƒæ›´æ–°å‡½æ•° ----
// å®æ—¶ä¿å­˜ä½†ä¸é‡æ’ï¼ˆé¿å…å¤±ç„¦ï¼‰
function editItemCellLive(idx, field, val){
  loadItems();
  if(!punchItems[idx]) return;
  punchItems[idx][field] = (field==='score') ? (Number(val)||0) : String(val);
  saveItems();
  updateEnabledTotalScoreUI();
}

// å¤±ç„¦åå†é‡æ’ & åˆ·æ–°ä¾èµ–ï¼ˆåªåœ¨ name/type è¿™ç§ä¼šå½±å“æ’åºæ—¶åšï¼‰
function commitItemCell(idx, field, val){
  editItemCellLive(idx, field, val);
  if(field==='name' || field==='type'){
    const act = getActiveItems();
    visibleItems = act.map((_, i)=>i);
    localStorage.setItem('visibleItems', JSON.stringify(visibleItems));
    renderItemSettings();
    updateEnabledTotalScoreUI();
rerenderChartPanel('monthStat');
    rerenderChartPanel('yearStat');
    renderCalendarPage();
  }
}
function editItemCell(idx, field, val) {
  loadItems();
  if (!punchItems[idx]) return;

  if (field === 'show') {
    punchItems[idx][field] = !!val;
  } else if (field === 'score') {
    punchItems[idx][field] = Number(val) || 0;
  } else {
    punchItems[idx][field] = String(val);
  }
  saveItems();

  if (field === 'show' || field === 'type' || field === 'name') {
    const act = getActiveItems();
    visibleItems = act.map((_, i) => i);
    localStorage.setItem('visibleItems', JSON.stringify(visibleItems));
    renderItemSettings();
    updateEnabledTotalScoreUI();    // â† æ–°å¢
    rerenderChartPanel('monthStat');
    rerenderChartPanel('yearStat');
    renderCalendarPage();
  } else {
    updateEnabledTotalScoreUI();    // â† æ–°å¢ï¼šä¾‹å¦‚åªæ”¹åˆ†æ•°
  }
}
function addNewItemRow(){
  punchItems.push({name:'', score:1, type:'', short:'', show:true});
  saveItems();
  renderItemSettings();
  updateEnabledTotalScoreUI();   // â† æ–°å¢
}
function deleteItem(idx) {
  if(!confirm('ç¡®å®šè¦åˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ')) return;
  punchItems.splice(idx,1);
  saveItems();
  renderItemSettings();
  updateEnabledTotalScoreUI();   // â† æ–°å¢
}
/* --------- æ—¥å†Tab ----------- */
const calendarBox = document.getElementById('calendarBox');
const today = new Date();
let curYear = today.getFullYear(), curMonth = today.getMonth()+1, curDay = today.getDate();
let viewYear = curYear, viewMonth = curMonth, viewDay = curDay;
let calendarMode = "month"; // "month"|"year"
let lastFilterTargetId = null;  // è®°ä½è§¦å‘ç­›é€‰çš„é¢æ¿ idï¼ˆ'monthStat' æˆ– 'yearStat'ï¼‰
let punchDayViewMode = false; // è¡¥å¡çŠ¶æ€

function openItemFilter(id, type) {
  lastFilterTargetId = id;
  const act = getActiveItems();

  let html = `
    <style>
      #item-filter-dialog input[type="checkbox"]:checked { accent-color: #ffbb66; }
    </style>
    <div id="item-filter-dialog" style="
      position:fixed; bottom:24px; right:14px; z-index:2001;
      background:#fff; border-radius:15px 13px 10px 10px;
      box-shadow:0 0 18px #0003; padding:18px 4px 12px 16px;">
  `;

  act.forEach((item, idx) => {
    html += `<label style="margin-right:15px;display:inline-block;">
      <input type="checkbox" value="${idx}" ${visibleItems.includes(idx) ? 'checked' : ''}/>
      ${item.name || ('é¡¹ç›®'+(idx+1))}
    </label>`;
  });

  html += `</div>
    <div id="item-filter-mask"
      style="position:fixed;left:0;top:0;width:100vw;height:100vh;background:#0002;z-index:2000;"
      onclick="applyItemFilter()"></div>
  `;

  document.body.insertAdjacentHTML('beforeend', html);
  document.getElementById('item-filter-dialog').addEventListener('click', e => e.stopPropagation());
}

function applyItemFilter() {
  const checks = [...document.querySelectorAll('#item-filter-dialog input[type=checkbox]:checked')];
  visibleItems = checks.map(c => +c.value);
  localStorage.setItem('visibleItems', JSON.stringify(visibleItems));
  closeItemFilter();
  rerenderChartPanel(lastFilterTargetId);  // âœ… æ ¹æ®æ¥æºåˆ·æ–° monthStat æˆ– yearStat
}

function closeItemFilter(){
  document.getElementById('item-filter-dialog')?.remove();
  document.getElementById('item-filter-mask')?.remove();
}

function rerenderChartPanel(id = 'monthStat') {
  const el = document.getElementById(id);
  if (!el) return; // é˜²å¾¡ï¼Œé¿å… null.outerHTML æŠ¥é”™
  el.outerHTML = (id === 'yearStat') ? getYearStatPanelHtml() : getMonthStatPanelHtml();
}

function getMonthDays(y,m){
  let days = [31,28,31,30,31,30,31,31,30,31,30,31];
  if(((y%4==0&&y%100!=0)||y%400==0)) days[1]=29;
  return days[m-1];
}
function getFirstDay(y,m){ return new Date(y,m-1,1).getDay(); }

function renderCalendarPage(){
  if(calendarMode==="month"){
    // âœ… ä¿®æ”¹è¿™é‡Œçš„HTMLç»“æ„
    let html = `<div class="calendar-header">
      <div class="calendar-header-left">
        <button class="calendar-switch" onclick="switchToYear()">å¹´è§†å›¾</button>
      </div>
      <div class="calendar-title">${viewYear}å¹´${viewMonth}æœˆ</div>
      <div class="calendar-header-right">
        <button class="calendar-switch" onclick="changeMonth(-1)">&lt;</button>
        <button class="calendar-switch" onclick="changeMonth(1)">&gt;</button>
      </div>
    </div>
    <table class="calendar-table">
      <thead>
        <tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr>
      </thead>
      <tbody id="monthBody"></tbody>
    </table>`;
    calendarBox.innerHTML = html + getMonthStatPanelHtml();
    renderMonthTable(viewYear,viewMonth);
  } else {
    let html = `<div class="year-header">
      <button class="year-nav-btn" onclick="changeYear(-1)">&lt;</button>
      <div class="year-title">${viewYear}å¹´</div>
      <button class="year-nav-btn" onclick="changeYear(1)">&gt;</button>
    </div>
    <div class="year-calendar" id="yearCalendar"></div>`;
    calendarBox.innerHTML = html + getYearStatPanelHtml(); // å¹´æŸ±çŠ¶å›¾æ’åˆ°å¹´å†tableå
    renderYearCalendar(viewYear);
  }
}
function renderMonthTable(y,m){
  const tb = document.getElementById('monthBody');
  tb.innerHTML = '';
  let days = getMonthDays(y,m);
  let first = getFirstDay(y,m);
  let row = [];
  for(let i=0;i<first;i++) row.push('');
  for(let d=1;d<=days;d++) row.push(d);
  while(row.length%7!==0) row.push('');
  for(let r=0;r<row.length;r+=7){
    let tr = document.createElement('tr');
    for(let c=0;c<7;c++){
      let day = row[r+c];
      let td = document.createElement('td');
      if(day){
        td.className = 'calendar-day';
        td.onclick = ()=> {
          viewYear = y; viewMonth = m; viewDay = day;
          punchDayViewMode = true; // è¡¥å¡
          switchTab('punch');
        };
        const log = punchLog[y]?.[m]?.[day];
        const val = log?.score || 0;

        if(val>0){
          const pool = getPoolByScore(val);   // âœ… æ”¹ä¸ºé˜ˆå€¼åˆ¤å®š
          td.classList.add(pool);             // âœ… A/B/P
        }

        const emojiHtml = (log?.emojis?.length > 0)
  ? log.emojis
      .map(v => (typeof v === 'number' ? emojiList[v] : v)) // å…¼å®¹æ—§æ•°æ®
      .slice(0, 2)
      .join('')
  : '';
        const scoreHtml = val ? `<span class="day-score">${val}</span>` : '';

        td.innerHTML = `<span class="day-num">${day}</span>
                        <span class="day-emoji">${emojiHtml}</span>
                        ${scoreHtml}`;
      }else{
        td.className = 'calendar-day disable';
        td.innerHTML = '';
      }
      tr.appendChild(td);
    }
    tb.appendChild(tr);
  }
}
function changeMonth(delta){
  let m = viewMonth + delta, y = viewYear;
  if(m<1){m=12;y--;}
  if(m>12){m=1;y++;}
  viewMonth = m; viewYear = y;
  renderCalendarPage();
}
function switchToYear(){
  calendarMode = "year";
  renderCalendarPage();
}
function switchToMonth(){
  calendarMode = "month";
  renderCalendarPage();
}
function changeYear(delta){
  viewYear += delta;
  renderCalendarPage();
}
function renderYearCalendar(year){
  const yearCalendar = document.getElementById('yearCalendar');
  if (!yearCalendar) return;
  
  // âœ… å¢åŠ ä¸€ä¸ªç›¸å¯¹å®šä½çš„çˆ¶çº§ï¼Œå¹¶æ”¾å…¥æ°”æ³¡å®¹å™¨
  yearCalendar.style.position = 'relative'; 
  
  let html = `<div class="popup-container" id="yearPopupContainer"></div>`; // æ°”æ³¡ç”»å¸ƒ

  for(let m=1; m<=12; m++){
    const mdays = getMonthDays(year,m);
    
    html += `<div class="month-block">
      <div class="month-title" onclick="jumpToMonth(${year},${m})">${m}æœˆ</div>
      <table class="days-table"><tbody>`;
      
    let d = 1;
    const firstDay = getFirstDay(year,m);
    for(let row=0; row<6; row++){
      html += "<tr>";
      for(let col=0; col<7; col++){
        if(row===0 && col<firstDay){
          html += `<td></td>`;
        } else if(d<=mdays){
          const log = punchLog[year]?.[m]?.[d];
          const val = log?.score || 0;
          let cls = "day-dot empty";
          if(val>0){
            const pool = getPoolByScore(val);
            cls = getYearDotClassByPool(pool);
          }
          html += `<td ${val > 0 ? `onclick="showYearDotEmoji(event, ${year}, ${m}, ${d})"` : ''}><span class="${cls}"></span></td>`;
          d++;
        } else {
          html += `<td></td>`;
        }
      }
      html += "</tr>";
      if(d > mdays) break;
    }
    html += `</tbody></table></div>`;
  }
  yearCalendar.innerHTML = html;
  
  // âœ… åœ¨åˆ‡æ¢é¡µé¢æˆ–å¹´ä»½æ—¶ï¼Œæ¸…ç©ºæ°”æ³¡
  function clearAllPopups() {
      const container = document.getElementById('yearPopupContainer');
      if (container) container.innerHTML = '';
  }
  // ç»‘å®šäº‹ä»¶ï¼Œå½“å¹´å†è§†å›¾æ»šåŠ¨æ—¶ï¼Œæ¸…ç©ºæ°”æ³¡ï¼ˆè¿™æ˜¯æœ€ç®€å•çš„è·Ÿéšæ–¹æ¡ˆï¼‰
  yearCalendar.onscroll = clearAllPopups;
}

function showYearDotEmoji(event, year, month, day) {
  event.stopPropagation();

  const popupContainer = document.getElementById('yearPopupContainer');
  if (!popupContainer) return;

  const log = punchLog[year]?.[month]?.[day];
  if (!log || !log.emojis || log.emojis.length === 0) return;

  // âœ… æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æ—¥æœŸçš„æ°”æ³¡ï¼Œå¦‚æœå­˜åœ¨åˆ™ç§»é™¤ï¼Œå®ç°â€œå¼€å…³â€æ•ˆæœ
  const existingPopupId = `popup-${year}-${month}-${day}`;
  const existingPopup = document.getElementById(existingPopupId);
  if (existingPopup) {
    existingPopup.remove();
    return;
  }
  
  const popup = document.createElement('div');
  popup.id = existingPopupId; // âœ… ç»™æ¯ä¸ªæ°”æ³¡ä¸€ä¸ªå”¯ä¸€çš„ID
  popup.className = 'year-dot-popup';
  popup.innerHTML = log.emojis
    .map(v => (typeof v === 'number' ? (emojiList[v] || '') : String(v)))
    .filter(Boolean)
    .join('');

  popupContainer.appendChild(popup);

  // å®šä½é€»è¾‘ä¸å˜ï¼Œä½†ç°åœ¨æ˜¯ç›¸å¯¹äºpopupContainer
  const dot = event.currentTarget;
  const dotRect = dot.getBoundingClientRect();
  const containerRect = popupContainer.getBoundingClientRect();
  
  const popupRect = popup.getBoundingClientRect(); // è·å–æ°”æ³¡çš„å°ºå¯¸

  let top = (dotRect.top - containerRect.top) - popupRect.height - 4;
  let left = (dotRect.left - containerRect.left) + (dotRect.width / 2) - (popupRect.width / 2);

  popup.style.top = `${top}px`;
  popup.style.left = `${left}px`;
// æ·»åŠ ä¸€ä¸ªä¸€æ¬¡æ€§çš„ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»é¡µé¢ä»»ä½•åœ°æ–¹éƒ½ä¼šå…³é—­æ°”æ³¡
  function closePopup() {
    if (popup) popup.remove();
    document.removeEventListener('click', closePopup);
  }
  setTimeout(() => document.addEventListener('click', closePopup), 0);
}

function jumpToMonth(y,m){
  viewYear = y; viewMonth = m;
  calendarMode = "month";
  renderCalendarPage();
}
/* ========= æŸ±çŠ¶å›¾ç»Ÿè®¡åŠŸèƒ½ ========== */

// ç®€å†™åç§°ï¼ˆé¡ºåºè¦ä¸ punchItemsRaw ä¸€è‡´ï¼‰
// é¡¹ç›®åˆ†ç»„ï¼ˆé‚»è¿‘åŒç±»ï¼‰ï¼šæŒ‰é¡ºåºä¸å˜å³å¯ï¼ŒæŸ±å­ä¼šæŒ‰æ•°ç»„é¡ºåºæ˜¾ç¤ºã€‚

// æŠ˜å é¢æ¿ç”Ÿæˆå‡½æ•° + ç­›é€‰æŒ‰é’®
function renderStatPanel(id, title, chartHtml, open = false) {
  // å…ˆåœ¨è¿™é‡ŒåŠ ä¸€è¡Œï¼Œç”Ÿæˆtype
  let type = id === 'monthStat' ? 'month' : 'year';

  return `
    <div class="stat-panel" id="${id}" style="position:relative;">
      <div class="stat-panel-header" onclick="toggleStatPanel('${id}')">
        <span>${title}</span>
        <span class="chevron-arrow ${open ? 'active' : ''}"></span>
      </div>
      <div class="stat-panel-body" style="display:${open ? 'block' : 'none'}">
        <button
          onclick="event.stopPropagation();openItemFilter('${id}', '${type}')"
          style="
            position:absolute;
            right:0px; bottom:2px;
            font-size:22px;
            background:transparent; border:none;
            box-shadow:none; color:#999; cursor:pointer; z-index:2;"
        >ğŸˆ</button>
        ${chartHtml}
      </div>
    </div>
  `;
}

// ä¸‰è§’æŠ˜å /å±•å¼€ï¼ˆä¸å˜ï¼‰
// --- è¿™æ˜¯æ–°å‡½æ•° ---
window.toggleStatPanel = function(id) {
  const panel = document.getElementById(id);
  if (!panel) return;

  const body = panel.querySelector('.stat-panel-body');
  const triangle = panel.querySelector('.chevron-arrow');
  if (!body || !triangle) return;

  const isOpen = body.style.display === 'block';
  body.style.display = isOpen ? 'none' : 'block';
  triangle.classList.toggle('active', !isOpen);
};

// ç»Ÿè®¡æ‰“å¡å¤©æ•°
function getItemStats(year, month = null) {
  const act = getActiveItems();
  const activeLen = act.length;
  let stats = new Array(activeLen).fill(0);

  if(month){ // æœˆ
    const days = getMonthDays(year, month);
    for(let d=1; d<=days; d++){
      const log = punchLog[year]?.[month]?.[d];
      if(!log?.checked) continue;
      for(const idx of log.checked){
        if(Number.isInteger(idx) && idx>=0 && idx<activeLen) stats[idx]++;
      }
    }
  }else{ // å¹´
    for(let m=1; m<=12; m++){
      const mdays = getMonthDays(year, m);
      for(let d=1; d<=mdays; d++){
        const log = punchLog[year]?.[m]?.[d];
        if(!log?.checked) continue;
        for(const idx of log.checked){
          if(Number.isInteger(idx) && idx>=0 && idx<activeLen) stats[idx]++;
        }
      }
    }
  }
  return stats;
}

// ç»˜åˆ¶æŸ±çŠ¶å›¾ï¼ˆæµ…ç°æŸ±ã€2-4å­—é¡¹ç›®åã€é¡¶éƒ¨æ˜¾ç¤ºæ¬¡æ•°ï¼Œåº•éƒ¨ä¸€æ¡æ¨ªçº¿ï¼Œæ¨ªå‘å¯æ»šåŠ¨ï¼‰
// æŸ±çŠ¶å›¾å‡åŒ€åˆ†å¸ƒã€yè½´é½å¹³ç‰ˆæœ¬
// ç»˜åˆ¶æŸ±çŠ¶å›¾ï¼ˆå‡åŒ€åˆ†å¸ƒï¼ŒYè½´é½å¹³ç‰ˆï¼Œæ¨ªå‘æ»šåŠ¨ï¼Œåº•éƒ¨å¯¹é½0%ï¼Œé¡¶éƒ¨å¯¹é½100%ï¼‰
function renderBarChart(stats, totalDays, idPrefix='') {
  const act = getActiveItems();

  const BAR_HEIGHT = 80;
  const LABEL_HEIGHT = 28;
  const BAR_WIDTH = 24;
  const BAR_GAP = 16;
  const Y_LABELS = [100, 80, 60, 40, 20, 0];
  const minWidth = (BAR_WIDTH + BAR_GAP) * stats.length;

  let yLabelsHtml = '';
  for (let i = 0; i < Y_LABELS.length; i++) {
    // âœ… æŠŠçº¿æ¡é¢œè‰²æ”¹å¾—æ›´æµ…(eee)ï¼Œä¸é‚£ä¹ˆæŠ¢çœ¼
    let top = (BAR_HEIGHT / (Y_LABELS.length - 1)) * i;
    yLabelsHtml += `
      <div style="position:absolute;left:0;width:4px;height:1px;background:#999;top:${top}px;"></div>
      <div style="position:absolute;left:-34px;top:${top-8}px;width:32px;text-align:right;font-size:12px;color:#bbb;z-index:2;">${Y_LABELS[i]}%</div>
    `;
  }

  let bars = '';
  for (let ii = 0; ii < visibleItems.length; ii++) {
    const i = visibleItems[ii];
    const item = act[i];
    if(!item) continue;
    
    const count = stats[i] || 0;
    const pct = totalDays > 0 ? Math.round(count / totalDays * 100) : 0;

    const countLabelHtml = count > 0 ? `
      <div style="
        position: absolute;
        bottom: ${pct}%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        color: #888;
        padding: 0 2px;
        line-height: 1.1;
        z-index: 3;
        /* --- 3. ç§»é™¤äº†æ•°å­—æ ‡ç­¾çš„èƒŒæ™¯è‰² --- */
      ">
        ${count}
      </div>
    ` : '';

    bars += `
      <div style="display:flex;flex-direction:column;align-items:center;width:${BAR_WIDTH}px;flex-shrink:0;">
        <div style="position:relative;width:100%;height:${BAR_HEIGHT}px;display:flex;align-items:flex-end;">
          
          <!-- 1. ç§»é™¤äº†åŸæ¥åœ¨è¿™é‡Œçš„ç°è‰²èƒŒæ™¯æ¡ -->
          <!-- 2. ç»™å½©è‰²æŸ±æ¡åŠ ä¸Šz-indexï¼Œè®©å®ƒâ€œæµ®â€åœ¨çº¿æ¡ä¹‹ä¸Š -->
          <div style="
            position: relative; /* å¿…é¡»æœ‰å®šä½ï¼Œz-indexæ‰èƒ½ç”Ÿæ•ˆ */
            z-index: 2; /* å…³é”®ï¼è®©å®ƒç›–ä½z-indexä¸ºé»˜è®¤0çš„æ¨ªçº¿ */
            width:100%;
            height:${pct}%;
            background:#cfd3db;
            border-radius:6px 6px 0 0;
            transition:height .3s;">
          </div>
          
          ${countLabelHtml}

        </div>
        <div style="
          font-size:12px;color:#444;
          white-space:normal;word-break:break-all;
          line-height:13px;text-align:center;width:100%;
          height:${LABEL_HEIGHT}px;
          display:flex;align-items:flex-end;justify-content:center;">
          ${getShortLabel(item)}
        </div>
      </div>
    `;
  }

  return `
    <div style="display:flex;flex-direction:row;align-items:flex-end;position:relative;padding:10px 10px 0 26px;">
      <div style="position:relative;height:${BAR_HEIGHT + LABEL_HEIGHT}px;width:10px;flex-shrink:0;">
        ${yLabelsHtml}
      </div>
      <div style="overflow-x:auto;width:100%;">
        <div style="display:flex;align-items:flex-end;gap:${BAR_GAP}px;min-width:${minWidth}px;height:${BAR_HEIGHT + LABEL_HEIGHT}px;">
          ${bars}
        </div>
      </div>
    </div>
  `;
}
// ç»Ÿè®¡å®é™…æœ‰æ‰“å¡çš„å¤©æ•°
function getMonthStatPanelHtml() {
  const stats = getItemStats(viewYear, viewMonth);
  const totalDays = getMonthDays(viewYear, viewMonth);

  // ç»Ÿè®¡æœ¬æœˆå·²æ‰“å¡å¤©æ•°
  let daysWithRecord = 0;
  for (let d = 1; d <= totalDays; d++) {
    if (punchLog[viewYear]?.[viewMonth]?.[d]?.score > 0) daysWithRecord++;
  }

  const chartHtml = renderBarChart(stats, totalDays, 'month');
  // åªæ˜¾ç¤ºä¸‹é¢è¿™ä¸€è¡Œï¼Œå¹¶ä¸”é å·¦
  const infoLine = `<div style="font-size:12px;color:#aaa;margin-top:2px;">${daysWithRecord}å¤© / ${totalDays}å¤©</div>`;
  return renderStatPanel('monthStat',
    `${viewYear}å¹´${viewMonth}æœˆæ‰“å¡ç»Ÿè®¡`,
    chartHtml + infoLine,
    false
  );
}

function getYearStatPanelHtml() {
  const stats = getItemStats(viewYear);
  const totalDays = getMonthDays(viewYear, 2) === 29 ? 366 : 365;

  // ç»Ÿè®¡å…¨å¹´å·²æ‰“å¡å¤©æ•°
  let daysWithRecord = 0;
  for (let m = 1; m <= 12; m++) {
    let mdays = getMonthDays(viewYear, m);
    for (let d = 1; d <= mdays; d++) {
      if (punchLog[viewYear]?.[m]?.[d]?.score > 0) daysWithRecord++;
    }
  }
  const chartHtml = renderBarChart(stats, totalDays, 'year');
  const infoLine = `<div style="font-size:12px;color:#aaa;margin-top:2px;">å·²æ‰“å¡å¤©æ•°ï¼š${daysWithRecord}å¤© / ç»Ÿè®¡å¤©æ•°ï¼š${totalDays}å¤©</div>`;
  return renderStatPanel('yearStat',
    `${viewYear}å¹´æ‰“å¡ç»Ÿè®¡`,
    chartHtml + infoLine,
    false
  );
}

/* ========== æŸ±çŠ¶å›¾æ ·å¼ ========== */
const statPanelCss = `
.stat-panel {margin:16px 0 10px 0;border:1px solid #eee;border-radius:11px;background:#fafbfc;}
.stat-panel-header {display:flex;align-items:center;justify-content:space-between;padding:9px 13px;font-weight:500;font-size:15px;cursor:pointer;}
.stat-panel-body {padding: 4px 10px 10px 10px;}
.stat-triangle {margin-left:8px;font-size:14px;color:#888;}
.bar-chart-row {display:flex;align-items:flex-end;gap:5px;}
.bar-item {transition:.2s;}
.bar-item .bar-outer {background:none;}
.bar-item .bar-outer>div:last-child {background:#bbb;}
`;
(function(){ // åŠ¨æ€æ’å…¥æ ·å¼
  let s = document.createElement('style'); s.innerHTML = statPanelCss;
  document.head.appendChild(s);
})();

/* ========== æ‰“å¡Tab ========== */
let shaking = false, shakeTimer = null;
function renderPunchPage(y, m, d) {
  const box = document.getElementById('punchBox');
  box.innerHTML = '';

  const log = punchLog[y]?.[m]?.[d] || { score: 0, emojis: [], checked: [], note: "" };

  let selectedEmojis = (log.emojis || [])
    .map(v => (typeof v === 'number' ? (emojiList[v] || '') : String(v)))
    .filter(Boolean);

  let checkedSet = new Set(log.checked || []);
  // âœ… ä¸è¦ç›´æ¥ç”¨æ—§åˆ†æ•°ï¼Œè€Œæ˜¯æ ¹æ®å‹¾é€‰çš„é¡¹ç›®é‡æ–°è®¡ç®—
  let scoreTotal = 0;
  const activeItems = getActiveItems(); // è·å–æ‰€æœ‰å¯ç”¨çš„æ‰“å¡é¡¹ç›®
  checkedSet.forEach(idx => {
    // ç¡®ä¿è¿™ä¸ªé¡¹ç›®è¿˜å­˜åœ¨ï¼Œå¹¶ä¸”æœ‰åˆ†æ•°
    if (activeItems[idx] && activeItems[idx].score) {
      scoreTotal += Number(activeItems[idx].score);
    }
  });
  let noteText = log.note || '';

  const isSelected = (idx) => {
    const val = emojiList[idx];
    if (!Array.isArray(selectedEmojis)) return false;
    return selectedEmojis.includes(idx) || selectedEmojis.includes(val);
  };

  // âœ… ç¬¬1ä¸ªæ”¹åŠ¨ï¼šç»™ emoji åŒºå¥—ä¸Šå¡ç‰‡å¤–å£³
  let emojiHtml = `
    <div class="punch-section-card">
      <div class="emoji-title">â£ï¸ å®å®ä»Šå¤©å¼€å¿ƒå—?</div>
      <div class="emoji-scroll-row" id="emojiRow">
  `;
  emojiList.forEach((emj, idx) => {
    emojiHtml += `
      <div class="emoji-btn ${isSelected(idx) ? 'selected' : ''}" data-idx="${idx}">
        ${emj}
        <span class="emoji-delete-btn" data-idx="${idx}">&times;</span>
      </div>
    `;
  });
  emojiHtml += `
      <div class="emoji-btn add" id="emojiAddBtn">+</div>
    </div>
  </div>`; // âœ… å¡ç‰‡å¤–å£³é—­åˆ

  // âœ… ç¬¬2ä¸ªæ”¹åŠ¨ï¼šç»™ checkcheck åŒºå¥—ä¸Šå¡ç‰‡å¤–å£³
  let checkHtml = `
    <div class="punch-section-card">
      <div class="check-title">âœ“ checkcheck <span class="score-bar" id="scoreBar">${scoreTotal}</span></div>
      <div class="check-list" id="checkList"></div>
    </div>
  `; // âœ… å¡ç‰‡å¤–å£³é—­åˆ

  // âœ… ç¬¬3ä¸ªæ”¹åŠ¨ï¼šç»™ç¢ç¢å¿µåŒºå¥—ä¸Šå¡ç‰‡å¤–å£³
  let noteHtml = `
    <div class="punch-section-card">
      <div class="note-title">ğŸ’Œ ä»Šå¤©çš„ç¢ç¢å¿µ</div>
      <textarea class="note-textarea" id="noteInput" placeholder="æƒ³è¯´ä»€ä¹ˆéƒ½å¯ä»¥å†™åœ¨è¿™é‡Œï½">${noteText || ''}</textarea>
      <div class="submit-row">
        <button class="submit-btn" id="submitBtn">æäº¤æ‰“å¡</button>
        <div id="submitTip" class="submit-tip"></div>
      </div>
    </div>
  `; // âœ… å¡ç‰‡å¤–å£³é—­åˆ

  // âœ… æœ€åç»„è£…æ—¶ï¼Œä¸éœ€è¦é¢å¤–åŠ  <div style="height:8px;"></div> äº†
  box.innerHTML = emojiHtml + checkHtml + noteHtml;
  function bindEmojiEvents() {
  const emojiRow = document.getElementById('emojiRow');
// å…ˆæŠŠå†å²é€‰è¿‡çš„è¡¨æƒ…é«˜äº®å‡ºæ¥
const selSet = new Set(selectedEmojis);
emojiRow.querySelectorAll('.emoji-btn').forEach(btn => {
  if (btn.classList.contains('add')) return;
  const i = parseInt(btn.dataset.idx);
  const val = emojiList[i];
  if (selSet.has(val)) btn.classList.add('selected');
});
  // ä¸è¦é‡å¤ let shaking...

  emojiRow.querySelectorAll('.emoji-btn').forEach((btn, idx) => {
    if (btn.classList.contains('add')) return;

    // æ™®é€šç‚¹å‡»
   btn.onclick = function (e) {
  if (shaking) return;
  const i   = parseInt(this.dataset.idx);
  const val = emojiList[i];        // ä¸€å¾‹ç”¨å­—ç¬¦è¿›è¡Œå­˜å‚¨/æ¯”è¾ƒ

  // æŠŠå½“å‰å·²é€‰è½¬æˆâ€œå­—ç¬¦æ•°ç»„â€ï¼Œé˜²æ­¢å†å²é‡Œæ··æœ‰æ•°å­—
  let selVals = (selectedEmojis || [])
    .map(v => (typeof v === 'number' ? (emojiList[v] || '') : String(v)))
    .filter(Boolean);

  if (this.classList.contains('selected')) {
    // å–æ¶ˆé€‰æ‹©
    this.classList.remove('selected');
    selVals = selVals.filter(v => v !== val);
  } else {
    // å·²ç»é€‰è¿‡ç›¸åŒçš„å°±ä¸é‡å¤
    if (selVals.includes(val)) return;

    if (selVals.length < 2) {
      this.classList.add('selected');
      selVals.push(val);
    } else {
      // åªä¿ç•™ä¸¤ä¸ªï¼šå»æ‰æœ€æ—©çš„ä¸€ä¸ªï¼Œå¹¶å–æ¶ˆå®ƒçš„é«˜äº®
      const oldest = selVals.shift();
      const oldestIdx = emojiList.indexOf(oldest);
      if (oldestIdx >= 0) {
        const oldBtn = emojiRow.querySelector(`.emoji-btn[data-idx="${oldestIdx}"]`);
        if (oldBtn) oldBtn.classList.remove('selected');
      }
      this.classList.add('selected');
      selVals.push(val);
    }
  }

  // å›å†™ä¸ºâ€œå­—ç¬¦æ•°ç»„â€
  selectedEmojis = selVals;
};

    // é•¿æŒ‰æŠ–åŠ¨+æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
    function triggerShake() {
      if (shaking) return;
      shaking = true;
      emojiRow.querySelectorAll('.emoji-btn').forEach(btn2 => {
        btn2.classList.add('shake');
        // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        const delBtn = btn2.querySelector('.emoji-delete-btn');
        if (delBtn) delBtn.style.display = 'flex';
      });
    }

    let longPressTimer = null;
    btn.onmousedown = function(e) {
      longPressTimer = setTimeout(triggerShake, 500);
    };
    btn.onmouseup = btn.onmouseleave = function(e) {
      clearTimeout(longPressTimer);
    };
    // ã€æ–°å¢ç§»åŠ¨ç«¯æ”¯æŒã€‘
    btn.ontouchstart = function(e) {
      longPressTimer = setTimeout(triggerShake, 500);
    };
    btn.ontouchend = btn.ontouchcancel = function(e) {
      clearTimeout(longPressTimer);
    };
  });

  // åˆ é™¤æŒ‰é’®äº‹ä»¶
  emojiRow.querySelectorAll('.emoji-delete-btn').forEach(delBtn => {
    delBtn.onclick = function(e) {
      e.stopPropagation();
      const idx = parseInt(this.dataset.idx);
      emojiList.splice(idx, 1);
localStorage.setItem('emojiList', JSON.stringify(emojiList));
      shaking = false;
      renderPunchPage(y, m, d);
    }
  });

  // ç‚¹å‡»ç©ºç™½é€€å‡ºæŠ–åŠ¨åˆ é™¤
  document.body.onclick = function(e) {
    if (shaking && !e.target.classList.contains('emoji-delete-btn')) {
      shaking = false;
      emojiRow.querySelectorAll('.emoji-btn').forEach(btn2 => {
        btn2.classList.remove('shake');
        const delBtn = btn2.querySelector('.emoji-delete-btn');
        if (delBtn) delBtn.style.display = 'none';
      });
    }
  };
  emojiRow.onclick = function(e) { e.stopPropagation(); };

  // åŠ å·æŒ‰é’®
  const emojiAddBtn = document.getElementById('emojiAddBtn');
  if (emojiAddBtn) {
    emojiAddBtn.onclick = function(e){
  e.stopPropagation();
  let newEmoji = prompt('è¯·è¾“å…¥ä½ æƒ³æ·»åŠ çš„emojiï¼š');
  if (newEmoji) {
    newEmoji = newEmoji.trim();
    if (!newEmoji) return;
    if (emojiList.includes(newEmoji)) {
      alert('è¿™ä¸ªè¡¨æƒ…å·²ç»åœ¨åˆ—è¡¨é‡Œäº†');
    } else {
      emojiList.push(newEmoji);
localStorage.setItem('emojiList', JSON.stringify(emojiList));
    }
    renderPunchPage(y, m, d);
  }
};
  }
}
  // checkåŒº
  // checkåŒº
const checkList = document.getElementById('checkList');

function renderCheckGrid() {
  const act = getActiveItems();
  checkList.innerHTML = '';
  act.forEach((item, idxInActive) => {
    const box = document.createElement('div');
    box.className = 'check-item';

    const btn = document.createElement('button');
    btn.type = 'button';
    const selected = checkedSet.has(idxInActive);
    btn.className = 'check-btn' + (selected ? ' selected':'');
    btn.textContent = item.name || ('é¡¹ç›®'+(idxInActive+1));
    btn.onclick = (e) => toggleCheck(idxInActive, Number(item.score||0), box, btn, e);

    box.appendChild(btn);
    checkList.appendChild(box);
  });
  updateScore();
}

function toggleCheck(idxInActive, score, boxDiv, btn, e) {
  score = Number(score||0);
  if (checkedSet.has(idxInActive)) {
    checkedSet.delete(idxInActive);
    scoreTotal -= score;
  } else {
    checkedSet.add(idxInActive);
    scoreTotal += score;
    showPlusAnim(btn, `+${score}`);
  }
  btn.classList.toggle('selected');
  updateScore();
  btn.blur();
}

function showPlusAnim(targetBtn, text){
  let anim = document.createElement('span');
  anim.className = 'plus-anim';
  anim.textContent = text;
  targetBtn.parentElement.appendChild(anim);
  setTimeout(()=>{ if(anim.parentElement) anim.parentElement.removeChild(anim); }, 830);
}

function updateScore(){
  document.getElementById('scoreBar').textContent = scoreTotal;
}
  renderCheckGrid();
  let noteInput = document.getElementById('noteInput');
  noteInput.oninput = ()=>{ noteText = noteInput.value; };

  document.getElementById('submitBtn').onclick = function(){
    punchLog[y] = punchLog[y]||{};
    punchLog[y][m] = punchLog[y][m]||{};
    punchLog[y][m][d] = {
      score: scoreTotal,
      emojis: selectedEmojis,
      checked: Array.from(checkedSet),
      note: noteText
    };
    localStorage.setItem('isla_punchLog', JSON.stringify(punchLog));
    let tip = document.getElementById('submitTip');
    tip.textContent = "ğŸ‰";
    setTimeout(()=>{ tip.textContent=''; }, 2500);
    // è‡ªåŠ¨å›åˆ°æ—¥å†ï¼Œåˆ·æ–°æŠ½å¡æ± 
    renderCalendarPage();
    updatePoolForDate(y, m, d);
    switchTab('pool', { date: { y: y, m: m, d: d } });
  };
  bindEmojiEvents();
}

/* ========== å¥–æƒ©æ± Tab ========== */

let poolType = 'B', drawn = false, drawnIdx = -1;

function renderCards() {
  const row = document.getElementById('cardRow');
  row.innerHTML = ''; 
  const cardBackUrl = (theme.cardBacks && theme.cardBacks[poolType]) ? theme.cardBacks[poolType] : '';
  const list = Array.isArray(poolData[poolType]) ? poolData[poolType] : [];
  if (list.length === 0) {
    row.innerHTML = '<div style="color:#999;min-height:170px;display:flex;align-items:center;">è¿™ä¸ªæ± å­è¿˜æ²¡æœ‰å¡ç‰‡å“¦</div>';
    document.getElementById('drawBtnContainer').style.display = 'none';
    return;
  }
  const cardBack = document.createElement('div');
  cardBack.className = 'card-back';
  cardBack.style.backgroundImage = `url('${cardBackUrl}')`;
  cardBack.style.cursor = 'default'; 
  row.appendChild(cardBack);
  document.getElementById('drawBtnContainer').style.display = 'block';
  document.getElementById('drawBtn').style.display = 'block';
}

// æŠ½å¡å‡½æ•°ï¼ŒæŠ½å¡æ¬¡æ•°ä¸ã€æ‰“å¡æ—¥ã€‘ç»‘å®š
function drawCard() {
  // --- 1. è·å–ã€å½“å‰æ­£åœ¨æ‰“å¡çš„æ—¥æœŸã€‘ä½œä¸ºé’¥åŒ™ ---
  // è¿™æ¬¡æˆ‘ä»¬ç”¨ viewYear, viewMonth, viewDayï¼Œä¹Ÿå°±æ˜¯ä½ åœ¨æ—¥å†ä¸Šé€‰ä¸­çš„é‚£ä¸€å¤©
  const punchDateKey = `${viewYear}-${String(viewMonth).padStart(2, '0')}-${String(viewDay).padStart(2, '0')}`;
  
  // --- 2. åŠ è½½æ•´ä¸ªæŠ½å¡å†å²è®°å½• ---
  // drawHistory ä¼šåƒè¿™æ ·: {"2025-08-11": {count: 1}, "2025-08-12": {count: 2}}
  let drawHistory = {};
  try {
    drawHistory = JSON.parse(localStorage.getItem('drawHistory')) || {};
  } catch (e) {
    drawHistory = {};
  }

  // --- 3. æ£€æŸ¥ã€å½“å‰æ‰“å¡æ—¥ã€‘çš„æ¬¡æ•°æ˜¯å¦å·²è¾¾ä¸Šé™ ---
  const todayCount = drawHistory[punchDateKey]?.count || 0;
  if (todayCount >= 2) {
    alert('ä¸è®¸è´ªå¿ƒï½');
    return; // ç»“æŸå‡½æ•°ï¼Œä¸æ‰§è¡ŒæŠ½å¡
  }

  // --- 4. æ‰§è¡Œæ­£å¸¸çš„æŠ½å¡é€»è¾‘ ---
  if (drawn) return;

  const cardBack = document.querySelector('#cardRow .card-back');
  if (!cardBack) return;

  const list = poolData[poolType] || [];
  if (list.length === 0) return;
  drawnIdx = Math.floor(Math.random() * list.length);
  const selectedCard = list[drawnIdx];

  cardBack.classList.add('flipped');
  drawn = true;
  document.getElementById('drawBtn').style.display = 'none';

  // --- 5. æŠ½å¥–æˆåŠŸåï¼Œã€å½“å‰æ‰“å¡æ—¥ã€‘çš„æ¬¡æ•°+1ï¼Œå¹¶ä¿å­˜å›æ•´ä¸ªå†å²è®°å½• ---
  drawHistory[punchDateKey] = { count: todayCount + 1 };
  localStorage.setItem('drawHistory', JSON.stringify(drawHistory));

  // --- 6. ç¿»è½¬å¡ç‰‡å¹¶æ˜¾ç¤ºç»“æœ (è¿™éƒ¨åˆ†ä¸å˜) ---
  setTimeout(() => {
    cardBack.style.opacity = '0'; 
    showResultCard(selectedCard);
  }, 700);
}

// ã€æœ€ç»ˆç‰ˆã€‘
// è¯·ç”¨è¿™ä¸ªå‡½æ•°å®Œæ•´æ›¿æ¢æ‚¨ç°æœ‰çš„ showResultCard å‡½æ•°
function showResultCard(card) {
    // 1. å‡†å¤‡èˆå°ï¼šæ¸…ç©ºæ—§å¡ç‰‡ï¼Œæ˜¾ç¤ºç‰¹æ•ˆå±‚å’Œç»“æœå¼¹çª—
    document.getElementById('cardRow').innerHTML = '';
    document.getElementById('fxLayer').style.display = 'block';
    document.getElementById('rewardPopup').style.display = 'flex';

    // 2. å¡«å……ç»“æœå¡ç‰‡çš„å†…å®¹å’Œæ ·å¼
    const frame = document.getElementById('rewardFrame');
    frame.className = 'reward-frame'; // å…ˆé‡ç½®
    frame.classList.add(`pool-${poolType}`); // å†æ ¹æ®å½“å‰æ± å­æ·»åŠ é¢œè‰²
    frame.querySelector('#rfTitle').textContent = card.title;
    frame.querySelector('#rfContent').textContent = card.desc;

    // 3. è¯»å–å¡ç‰‡è‡ªå·±çš„ç‰¹æ•ˆè®¾ç½®ï¼Œå¹¶å¯åŠ¨å¯¹åº”çš„ç‰¹æ•ˆ
    const effectType = card.effectType || 'barrage'; // é»˜è®¤ä¸ºå¼¹å¹•

    if (effectType === 'rain') {
        // å¦‚æœæ˜¯ä¸‹è½ç‰¹æ•ˆï¼Œè°ƒç”¨å‡çº§åçš„ startRain å‡½æ•°
        // startRain å‡½æ•°è‡ªå·±ä¼šåˆ¤æ–­å¡ç‰‡é‡Œæœ‰æ²¡æœ‰å›¾ç‰‡é“¾æ¥
        startRain(card);
    } else {
        // å¦åˆ™ï¼Œå¯åŠ¨å¼¹å¹•ç‰¹æ•ˆ
        const barrages = card.barrages || [];
        startBarrage(barrages);
    }
}

// åŒæ—¶æ›¿æ¢è¿™ä¸ªå‡½æ•°
function resetDraw() {
  stopEffects();
  document.getElementById('fxLayer').style.display = 'none';
  
  // âœ… æ–°å¢ï¼šéšè—å¼¹çª—
  document.getElementById('rewardPopup').style.display = 'none';

// æŠŠâ€œå·²æŠ½å¥–â€çš„çŠ¶æ€é‡ç½®ä¸ºâ€œæœªæŠ½å¥–â€ï¼Œè¿™æ ·ä¸‹æ¬¡æ‰èƒ½ç‚¹
  drawn = false;
  renderCards();
}

// ===== å¼¹å¹• & å°é›¨ï¼šæ§åˆ¶å™¨ =====
let barrageTimer = null;
let rainTimer = null;
function stopEffects(){
  // åœå¼¹å¹•
  if (barrageTimer) { clearInterval(barrageTimer); barrageTimer = null; }
  const fx = document.getElementById('fxLayer');
  if (fx) fx.innerHTML = '';

  // åœé›¨
  if (rainTimer) { clearInterval(rainTimer); rainTimer = null; }
}

// å¯åŠ¨å¼¹å¹• (ç»ˆæä¸æ»‘ç‰ˆï¼Œä½¿ç”¨é€’å½’ setTimeout)
function startBarrage(lines) { // ç›´æ¥æ¥æ”¶å¼¹å¹•æ•°ç»„
    stopEffects();
    if (!lines || lines.length === 0) return;

  const fx = document.getElementById('fxLayer');
  if (!fx) return;

  const W = fx.clientWidth;

  // è¿™æ˜¯æˆ‘ä»¬çš„â€œç”Ÿæˆå™¨â€
  const spawnBullet = () => {
    const el = document.createElement('div');
    el.className = 'bullet';
    el.textContent = lines[Math.floor(Math.random() * lines.length)];

    el.style.opacity = '0';
    fx.appendChild(el);

    const elWidth = el.clientWidth;
    const maxLeft = W - elWidth;
    const x = Math.random() * (maxLeft > 0 ? maxLeft : 0);
    const duration = 9000 + Math.random() * 7000;

    el.style.left = `${x}px`;
    el.style.animationDuration = `${duration}ms`;
    el.style.opacity = '1';

    setTimeout(() => { el.remove(); }, duration);

    // --- å…³é”®æ”¹åŠ¨åœ¨è¿™é‡Œï¼---
    // ç”Ÿæˆå®Œä¸€æ¡åï¼Œéšæœºç­‰å¾… 700ms åˆ° 1500msï¼Œå†è°ƒç”¨è‡ªå·±å»ç”Ÿæˆä¸‹ä¸€æ¡
    const nextSpawnTime = 700 + Math.random() * 800; 
    barrageTimer = setTimeout(spawnBullet, nextSpawnTime);
  };

  // ç«‹å³å¼€å§‹ç¬¬ä¸€æ¡å¼¹å¹•çš„ç”Ÿæˆ
  spawnBullet(); 
}

// å¯åŠ¨å°é›¨
function startRain(card) { // âœ… ç°åœ¨å®ƒæ¥æ”¶ä¸€æ•´ä¸ª card å¯¹è±¡
    stopEffects();
    const fx = document.getElementById('fxLayer');
    if (!fx) return;
    const W = fx.clientWidth;

    // âœ… æ£€æŸ¥å¡ç‰‡æ•°æ®é‡Œæ˜¯å¦æœ‰è‡ªå®šä¹‰çš„å›¾ç‰‡é“¾æ¥
    const useCustomImage = card && card.rainImageUrl;

    const spawnDrop = () => {
        let el; // å£°æ˜ä¸€ä¸ªå˜é‡æ¥è£…æˆ‘ä»¬çš„ä¸‹è½ç‰©

        if (useCustomImage) {
            // --- å¦‚æœæœ‰è‡ªå®šä¹‰å›¾ç‰‡é“¾æ¥ ---
            el = document.createElement('img');
            el.src = card.rainImageUrl;
            el.className = 'rain-image'; // ä½¿ç”¨ä¸ºå›¾ç‰‡è®¾è®¡çš„ä¸“å±æ ·å¼
        } else {
            // --- å¦‚æœæ²¡æœ‰ï¼Œå°±ç”¨é»˜è®¤çš„CSSé›¨æ»´ ---
            el = document.createElement('div');
            el.className = 'drop';
        }

        el.style.left = `${Math.random() * W}px`;

        // æ ¹æ®æ˜¯å›¾ç‰‡è¿˜æ˜¯é›¨æ»´ï¼Œä½¿ç”¨ä¸åŒçš„åŠ¨ç”»
        const duration = 1.5 + Math.random() * 2;
        const animationName = useCustomImage ? 'rainFallWithFlutter' : 'rainFall';
        el.style.animation = `${animationName} ${duration}s linear forwards`;

        fx.appendChild(el);
        setTimeout(() => el.remove(), duration * 1000 + 100);
    };

    rainTimer = setInterval(() => {
        // ä¸ºäº†è§†è§‰æ•ˆæœï¼Œå›¾ç‰‡ä¸€æ¬¡å°‘ä¸‹å‡ ä¸ªï¼Œé›¨æ»´å¯ä»¥å¤šä¸‹å‡ ä¸ª
        const spawnCount = useCustomImage ? 2 : 5;
        for (let i = 0; i < spawnCount; i++) spawnDrop();
    }, 150); // é¢‘ç‡ä¹Ÿç¨å¾®é™ä½ä¸€ç‚¹
}
/* ========== TabBaræ§åˆ¶ ========== */
const tabBtns = document.querySelectorAll('.tab-btn');
// ===== Tab åˆ‡æ¢ï¼ˆè€æ‰“ç‰ˆï¼‰=====
// ã€ç»ˆæç‰ˆã€‘
function switchTab(tab, options = {}){ // å¢åŠ ä¸€ä¸ªå¯é€‰çš„ options å‚æ•°
  if (tab !== 'pool') stopEffects();
  const validTabs = ['calendar','punch','pool','me'];
  if (!validTabs.includes(tab)) tab = 'calendar';

  // è§†å›¾å’ŒæŒ‰é’®é«˜äº® (ä¸å˜)
  document.querySelectorAll('.view-page.active').forEach(el=>el.classList.remove('active'));
  const view = document.getElementById('tab-'+tab);
  if (view) view.classList.add('active');
  document.querySelectorAll('.tab-btn.active').forEach(b=>b.classList.remove('active'));
  const btn = document.querySelector(`.tab-btn[data-tab="${tab}"]`)
           || document.querySelector('.tab-btn[data-tab="calendar"]');
  if (btn) btn.classList.add('active');

  // ä¸šåŠ¡åˆ·æ–°
  if (tab === 'punch') {
    if (!punchDayViewMode){ viewYear = curYear; viewMonth = curMonth; viewDay = curDay; }
    renderPunchPage(viewYear, viewMonth, viewDay);
    punchDayViewMode = false;
  } else if (tab === 'calendar') {
    renderCalendarPage();
  } else if (tab === 'pool') {
    // --- æ ¸å¿ƒæ”¹åŠ¨åœ¨è¿™é‡Œ ---
    // å¦‚æœ options é‡Œå¸¦äº†æ—¥æœŸï¼Œå°±ç”¨é‚£ä¸ªæ—¥æœŸï¼›å¦åˆ™ï¼Œç”¨é»˜è®¤çš„ä»Šå¤©
    if (options.date) {
      updatePoolForDate(options.date.y, options.date.m, options.date.d);
    } else {
      updatePoolForDate(); // ä¸å¸¦å‚æ•°ï¼Œé»˜è®¤ä½¿ç”¨ä»Šå¤©çš„æ—¥æœŸ
    }
  } else if (tab === 'me') {
    if (typeof renderMeTab === 'function') renderMeTab();
  }
}

// ======== å¥–æ± æ•°æ®ç»“æ„ä¸æ¸²æŸ“ ===========
function escapeHtml(s){
  return String(s??'')
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

poolData = JSON.parse(localStorage.getItem('poolData') || '{}');
const defaultPools = {
  'A': [{ title: 'ç¤ºä¾‹å¥–åŠ±', desc: 'è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å¥–åŠ±', tips: '' }],
  'B': [],
  'P': []
};
if(!poolData.A || !poolData.B || !poolData.P){
  poolData = JSON.parse(JSON.stringify(defaultPools));
  localStorage.setItem('poolData', JSON.stringify(poolData));
}
// ========== å¥–æ± åˆ†é¡µï¼ˆA/B/Pï¼‰ä¸€ç«™å¼ç‰ˆæœ¬ ==========

// å½“å‰æ¿€æ´»çš„æ± ï¼ˆé»˜è®¤ Aï¼‰
let activePool = 'A';

function savePoolData(){
  localStorage.setItem('poolData', JSON.stringify(poolData));
}

// ã€å…¨æ–°å‡½æ•°2ï¼šç‰¹æ•ˆé¢æ¿æŠ˜å /å±•å¼€ã€‘
// --- è¿™æ˜¯æ–°å‡½æ•° ---
function toggleEffectPanel(poolType, idx) {
    const body = document.getElementById(`effect_body_${poolType}_${idx}`);
    const triangle = document.getElementById(`effect_triangle_${poolType}_${idx}`);
    if (!body || !triangle) return;

    const isOpen = body.style.display === 'block';
    body.style.display = isOpen ? 'none' : 'block';
    triangle.classList.toggle('active', !isOpen);
}

function renderPoolList() {
  const container = document.getElementById('poolList');
  if (!container) return;

  // ä½¿ç”¨ activePool å…¨å±€å˜é‡æ¥å†³å®šå“ªä¸ªæŒ‰é’®æ˜¯æ¿€æ´»çš„
  container.innerHTML = `
    <div class="item-settings-panel">
      <div class="pool-tabs">
        <button class="pool-tab ${activePool === 'A' ? 'active' : ''}" data-k="A" onclick="switchPool('A')">Aæ± </button>
        <button class="pool-tab ${activePool === 'B' ? 'active' : ''}" data-k="B" onclick="switchPool('B')">Bæ± </button>
        <button class="pool-tab ${activePool === 'P' ? 'active' : ''}" data-k="P" onclick="switchPool('P')">Pæ± </button>
      </div>
      
      <div class="pool-block">
        <div id="poolTitle" class="pool-title">${activePool}æ± </div>
        <div id="poolCards_active">
          <!-- å¡ç‰‡å†…å®¹å°†ç”± renderActivePool åŠ¨æ€æ¸²æŸ“åˆ°è¿™é‡Œ -->
        </div>
      </div>
      
      <div class="bottom-row" style="margin-top:10px;">
         <button class="add-btn" onclick="addPoolCardRow(activePool)">+ æ–°å¢å¥–é¡¹åˆ° ${activePool} æ± </button>
      </div>
    </div>
  `;
  
  // ç¡®ä¿UIå’Œæ•°æ®åŒæ­¥
  updatePoolTabsUI();
  renderActivePool(); 
}

/** åˆ‡æ¢å½“å‰æ±  */
/** åˆ‡æ¢å½“å‰æ±  */
function switchPool(k){
  if (!['A','B','P'].includes(k)) return;
  activePool = k;
  renderPoolList(); // <-- ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå®ƒä¼šè´Ÿè´£æå®šä¸€åˆ‡ï¼
}

/** æ›´æ–° tabs çš„é€‰ä¸­æ€ */
function updatePoolTabsUI(){
  document.querySelectorAll('#poolList .pool-tab').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.k === activePool);
  });
}

/** æ¸²æŸ“å½“å‰æ± æ ‡é¢˜ä¸å†…å®¹åˆ°ç»Ÿä¸€å®¹å™¨ */
function renderActivePool(){
  const titleEl = document.getElementById('poolTitle');
  if (titleEl) titleEl.textContent = `${activePool}æ± `;
  renderPoolCards(activePool, 'poolCards_active');
}

/**
 * æ¸²æŸ“æŸä¸ªæ± åˆ°æŒ‡å®šå®¹å™¨
 * @param {'A'|'B'|'P'} poolType
 * @param {string} targetId ç›®æ ‡å®¹å™¨ idï¼ˆå¯é€‰ï¼›ä¸ä¼ åˆ™ç”¨æ—§å‘½å poolCards_Xï¼‰
 */
// ã€å‡çº§ç‰ˆã€‘
function renderPoolCards(poolType, targetId) {
    const cards = poolData[poolType] || [];
    const cont = document.getElementById(targetId || `poolCards_${poolType}`);
    if (!cont) return;

    let html = '';
    cards.forEach((card, idx) => {
        // ä¸ºæ¨¡æ¿å‡†å¤‡å¥½æ‰€æœ‰éœ€è¦çš„æ•°æ®
        const effectType = card.effectType || 'barrage';
        const barrages = (card.barrages || []).join('\n');
        // è·å–å¡ç‰‡ä¿å­˜çš„å›¾ç‰‡é“¾æ¥ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºç©ºå­—ç¬¦ä¸²
        const rainImageUrl = card.rainImageUrl || '';

        html += `
            <div class="pool-card-row">
                <!-- å¡ç‰‡æ ‡é¢˜ã€æè¿°ã€åˆ é™¤æŒ‰é’® (è¿™éƒ¨åˆ†ä¸å˜) -->
                <div class="card-title-row">
                    <div class="ed-title" contenteditable="true" oninput="editCardField('${poolType}',${idx},'title',this.innerText)">${escapeHtml(card.title)}</div>
                    <button class="del-btn" onclick="deletePoolCard('${poolType}',${idx})">ğŸ—‘ï¸</button>
                </div>
                <div class="ed-line" contenteditable="true" oninput="editCardField('${poolType}',${idx},'desc',this.innerText)">${escapeHtml(card.desc)}</div>
                <div class="ed-line" contenteditable="true" oninput="editCardField('${poolType}',${idx},'tips',this.innerText)">${escapeHtml(card.tips)}</div>

                <!-- ç‰¹æ•ˆè®¾ç½®åŒºåŸŸ -->
                <div style="background: rgba(120,120,120,0.05); border-radius: 8px; padding: 10px; margin-top: 12px; text-align: left;">
                    
                    <!-- å¯ç‚¹å‡»çš„æ ‡é¢˜è¡Œï¼Œå¸¦å°ä¸‰è§’ -->
    <div style="font-size: 14px; ..." onclick="toggleEffectPanel('${poolType}', ${idx})">
        ç‰¹æ•ˆè®¾ç½®
        <span id="effect_triangle_${poolType}_${idx}" class="chevron-arrow"></span>
    </div>
                    
                    <!-- é»˜è®¤éšè—çš„ç‰¹æ•ˆå†…å®¹åŒº -->
                    <div id="effect_body_${poolType}_${idx}" style="display: none;">
                        <!-- ç‰¹æ•ˆç±»å‹å•é€‰æŒ‰é’® (å¼¹å¹• vs ä¸‹è½) -->
                        <div style="display: flex; gap: 15px; margin: 8px 0;">
                            <label><input type="radio" name="effect_${poolType}_${idx}" value="barrage" ${effectType === 'barrage' ? 'checked' : ''} onchange="editCardField('${poolType}',${idx},'effectType',this.value)"> å¼¹å¹•</label>
                            <label><input type="radio" name="effect_${poolType}_${idx}" value="rain" ${effectType === 'rain' ? 'checked' : ''} onchange="editCardField('${poolType}',${idx},'effectType',this.value)"> ä¸‹è½</label>
                        </div>

                        <!-- ç‰¹æ•ˆå…·ä½“å†…å®¹è®¾ç½® -->
                        <div id="effect_content_${poolType}_${idx}">
                            ${ effectType === 'barrage'
                              ? `<!-- å¦‚æœæ˜¯å¼¹å¹•ï¼Œæ˜¾ç¤ºå¤šè¡Œæ–‡æœ¬æ¡† -->
                                <textarea class="note-textarea" style="min-height: 80px; margin-bottom: 0;" placeholder="ä¸€è¡Œä¸€æ¡å¼¹å¹•" oninput="editCardBarrages('${poolType}', ${idx}, this.value)">${escapeHtml(barrages)}</textarea>`
                              : `<!-- å¦‚æœæ˜¯ä¸‹è½ï¼Œæ˜¾ç¤ºå›¾ç‰‡é“¾æ¥è¾“å…¥æ¡† -->
                                <input type="text" class="th-input" style="width: 100%;" 
                                       placeholder="ç²˜è´´å›¾ç‰‡é“¾æ¥ (å¯ä¸ºç©ºï¼Œé»˜è®¤ä¸ºé›¨æ»´)" 
                                       value="${escapeHtml(rainImageUrl)}" 
                                       oninput="editCardField('${poolType}',${idx},'rainImageUrl',this.value)">`
                            }
                        </div>
                    </div>
                </div>
                <div class="row-divider"></div>
            </div>
        `;
    });
    cont.innerHTML = html;
}

// â€”â€” ç›´æ¥ç¼–è¾‘å³ä¿å­˜ â€”â€” //
// è¯·ç”¨è¿™ä¸ªå‡½æ•°å®Œæ•´æ›¿æ¢æ‚¨ç°æœ‰çš„ editCardField å‡½æ•°
function editCardField(poolType, idx, field, value) {
    if (!poolData[poolType] || !poolData[poolType][idx]) return;

    poolData[poolType][idx][field] = value;
    savePoolData();
    
    // å…³é”®ï¼šå¦‚æœä¿®æ”¹çš„æ˜¯ç‰¹æ•ˆç±»å‹ï¼Œç«‹å³åˆ·æ–°UIï¼Œä»¥ä¾¿æ˜¾ç¤ºæ­£ç¡®çš„è¾“å…¥æ¡†
    if (field === 'effectType') {
        renderActivePool();
    }
}

// ã€å…¨æ–°ã€‘ä¸“é—¨å¤„ç†å¼¹å¹•ï¼ˆå› ä¸ºå®ƒéœ€è¦æŒ‰è¡Œåˆ†å‰²ï¼‰
function editCardBarrages(poolType, idx, text) {
    if (!poolData[poolType] || !poolData[poolType][idx]) return;
    const lines = text.split('\n').map(line => line.trim()).filter(Boolean);
    poolData[poolType][idx].barrages = lines;
    savePoolData();
}

// ã€å…¨æ–°ã€‘åˆ é™¤å¡ç‰‡æ—¶ä¹Ÿè¦ç¡®ä¿æ•°æ®å¹²å‡€
function deletePoolCard(poolType, idx) {
    if(!confirm('ç¡®å®šåˆ é™¤è¯¥å¥–é¡¹ï¼Ÿ')) return;
    poolData[poolType].splice(idx, 1);
    savePoolData();
    renderActivePool();
}

function addPoolCardRow(poolType){
  if (!poolData[poolType]) {
    poolData[poolType] = [];
  }
  // æ·»åŠ ä¸€å¼ å¸¦é»˜è®¤ç‰¹æ•ˆè®¾ç½®çš„ç©ºå¡ç‰‡
  poolData[poolType].push({
    title: 'æ–°å¥–é¡¹', 
    desc: 'åœ¨è¿™é‡Œå¡«å†™æè¿°', 
    tips: 'åœ¨è¿™é‡Œå¡«å†™æç¤º',
    effectType: 'barrage', // é»˜è®¤æ˜¯å¼¹å¹•
    rainContent: 'â¤ï¸',    // é»˜è®¤ä¸‹çˆ±å¿ƒ
    barrages: []          // å¼¹å¹•åˆ—è¡¨ä¸ºç©º
  });
  savePoolData();
  renderActivePool();
}
// ========== é€šç”¨æŠ˜å /å±•å¼€æœºåˆ¶ ==========
function togglePanel(panelId) {
  const panel = document.getElementById(panelId);
  const body = panel.querySelector('.setting-panel-body');
  const isOpen = body.style.display === 'block';
  if(isOpen){
    body.style.display = 'none';
    panel.classList.remove('active');
  }else{
    // å…ˆå…¨éƒ¨å…³æ‰
    document.querySelectorAll('.setting-panel').forEach(p=>{
      if(p!==panel){
        p.classList.remove('active');
        const b = p.querySelector('.setting-panel-body');
        if(b) b.style.display = 'none';
      }
    });
    body.style.display = 'block';
    panel.classList.add('active');
    // å±•å¼€æ—¶æ¸²æŸ“å†…å®¹
    if(panelId==='poolPanel') renderPoolList();
    if(panelId==='meSettingsPanel') renderItemSettings();
  }
}

// ===== å•ä¸»é¢˜ï¼Œä¸åˆ†æ—¥å¤œ =====
theme = JSON.parse(localStorage.getItem('theme') || 'null') || {
  A: { calendar:'rgba(244,179,194,0.27)', dot:'#f4b3c2' },
  B: { calendar:'rgba(227,235,152,0.27)', dot:'#e3eb98' },
  P: { calendar:'rgba(92,179,204,0.16)',  dot:'#5cb3cc' },
  cardBacks: {
    A: '',
    B: '',
    P: ''
  },
  base:{ bg:'#ffffff', fg:'#222222', panel:'#fafbfc', border:'#eeeeee' },
  check:{ border:'#ff9900', bg:'#ffffff', text:'#ff7700' }
};

function setCssVar(k,v){ document.documentElement.style.setProperty(k,v); }

function applyTheme(){
  if (!theme) return; // å¢åŠ ä¸€ä¸ªå®‰å…¨æ£€æŸ¥
  // A/B/P é¢œè‰²è®¾ç½®
  if (theme.A) {
    setCssVar('--A-cal-bg', theme.A.calendar);
    setCssVar('--A-dot', theme.A.dot);
  }
  if (theme.B) {
    setCssVar('--B-cal-bg', theme.B.calendar);
    setCssVar('--B-dot', theme.B.dot);
  }
  if (theme.P) {
    setCssVar('--P-cal-bg', theme.P.calendar);
    setCssVar('--P-dot', theme.P.dot);
  }
  // åŸºç¡€é¢œè‰²
  if (theme.base) {
    setCssVar('--app-bg', theme.base.bg);
    setCssVar('--app-fg', theme.base.fg);
    setCssVar('--panel-bg', theme.base.panel);
    setCssVar('--panel-border', theme.base.border);
  }
  // æ‰“å¡é€‰ä¸­æ€
  if (theme.check) {
    setCssVar('--check-selected-border', theme.check.border);
    setCssVar('--check-selected-bg', theme.check.bg);
    setCssVar('--check-selected-fg', theme.check.text);
  }
}

// rgba -> #rrggbbï¼ˆç»™ <input type="color"> ç”¨ï¼‰
function toColorInput(v){
  try{
    if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v)) return v;
    const m = v.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
    if(m){
      const r = (+m[1]).toString(16).padStart(2,'0');
      const g = (+m[2]).toString(16).padStart(2,'0');
      const b = (+m[3]).toString(16).padStart(2,'0');
      return '#'+r+g+b;
    }
  }catch(e){}
  return '#000000';
}

// â€”â€” é¢œè‰²é¢æ¿ï¼šä¸€å¼ å¤§å¡ï¼ŒåŒè¡Œã€Œåç§° + è‰²ç›˜ + è‰²å·ã€ â€”â€” //
function renderColorList(){
  const cont = document.getElementById('colorList'); if(!cont) return;
  const colorRows = [
    ['Aæ± ï¼šæœˆå†æ ¼å­åº•è‰²',['A','calendar']], ['Aæ± ï¼šå¹´å†ç‚¹ç‚¹',['A','dot']],
    ['Bæ± ï¼šæœˆå†æ ¼å­åº•è‰²',['B','calendar']], ['Bæ± ï¼šå¹´å†ç‚¹ç‚¹',['B','dot']],
    ['Pæ± ï¼šæœˆå†æ ¼å­åº•è‰²',['P','calendar']], ['Pæ± ï¼šå¹´å†ç‚¹ç‚¹',['P','dot']],
    ['æ‰“å¡é¡µé€‰ä¸­ï¼šè¾¹æ¡†',['check','border']], ['æ‰“å¡é¡µé€‰ä¸­ï¼šèƒŒæ™¯',['check','bg']], ['æ‰“å¡é¡µé€‰ä¸­ï¼šæ–‡å­—',['check','text']]
  ];
  const imageRows = [
      ['Aæ± å¡èƒŒå›¾ç‰‡', ['cardBacks', 'A']],
      ['Bæ± å¡èƒŒå›¾ç‰‡', ['cardBacks', 'B']],
      ['Pæ± å¡èƒŒå›¾ç‰‡', ['cardBacks', 'P']]
  ];
  const makeColorRow = (label, path) => {
    const v = path.reduce((o, k) => (o && o[k] !== undefined) ? o[k] : '', theme);
    const id = path.join('_');
    return `<div class="color-row">
        <div class="label">${label}</div>
        <div class="inputs">
          <input type="color" value="${toColorInput(v)}" onchange="onColorPick2('${id}',this.value)">
          <input type="text" value="${String(v).replace(/"/g,'&quot;')}" oninput="onColorHex2('${id}',this.value)">
        </div>
      </div>`;
  };
  const makeImageRow = (label, path) => {
    const v = path.reduce((o, k) => (o && o[k] !== undefined) ? o[k] : '', theme);
    const id = path.join('_');
    return `<div class="color-row">
        <div class="label">${label}</div>
        <div class="inputs">
          <input type="text" style="width: 100%;" placeholder="ç²˜è´´å›¾ç‰‡é“¾æ¥" value="${escapeHtml(v)}" oninput="onColorHex2('${id}',this.value)">
        </div>
      </div>`;
  };
  cont.innerHTML = `
    <div class="color-wrap">
      ${colorRows.map(r=>makeColorRow(r[0], r[1])).join('')}
    </div>
    <div class="color-wrap" style="margin-top: 16px;">
      ${imageRows.map(r=>makeImageRow(r[0], r[1])).join('')}
    </div>
  `;
}

function onColorPick2(idPath, value){ setThemeValueById2(idPath, value); }
function onColorHex2(idPath, value){ setThemeValueById2(idPath, value); }
// âœ… æ›¿æ¢ä¸ºæ‚¨ä»£ç ä¸­ç°æœ‰çš„ setThemeValueById2 å‡½æ•°
function setThemeValueById2(idPath, val) {
    const ks = idPath.split('_');
    let current = theme;

    // éå†è·¯å¾„ï¼Œå¦‚æœä¸­é—´çš„å¯¹è±¡ä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºå®ƒ
    for (let i = 0; i < ks.length - 1; i++) {
        const key = ks[i];
        if (!current[key] || typeof current[key] !== 'object') {
            current[key] = {}; 
        }
        current = current[key];
    }

    // åœ¨æœ€ç»ˆçš„ä½ç½®è®¾ç½®å€¼
    current[ks[ks.length - 1]] = val;
    
    // ä¿å­˜å¹¶åº”ç”¨
    localStorage.setItem('theme', JSON.stringify(theme));
    applyTheme();
}

// â€”â€” å•ä¸»é¢˜ä¸‹çš„â€œæ¢å¤é»˜è®¤â€ â€”â€” //
function resetThemeToDefault(){
  theme = {
    A: { calendar:'rgba(244,179,194,0.27)', dot:'#f4b3c2' },
    B: { calendar:'rgba(227,235,152,0.27)', dot:'#e3eb98' },
    P: { calendar:'rgba(92,179,204,0.16)',  dot:'#5cb3cc' },
    cardBacks: {
      A: '',
    B: '',
    P: ''
    },
    base:{ bg:'#ffffff', fg:'#222222', panel:'#fafbfc', border:'#eeeeee' },
    check:{ border:'#ff9900', bg:'#ffffff', text:'#ff7700' }
  };
  localStorage.setItem('theme', JSON.stringify(theme));
  renderColorList();
  applyTheme();
}

/* ========= å¥–æ± é˜ˆå€¼ï¼ˆæ›¿æ¢ç¡¬ç¼–ç  48 / 34ï¼‰ ========= */
// ===== ç»Ÿä¸€çš„åˆ†æ•°â†’æ± å­åˆ¤å®š + å¹´å†ç‚¹ç‚¹é¢œè‰²æ˜ å°„ =====
function getPoolByScore(score){
  if(score >= (poolThresholds?.A ?? 48)) return 'A';
  if(score >= (poolThresholds?.B ?? 34)) return 'B';
  return 'P';
}
function getYearDotClassByPool(pool){
  // å¹´å†é‡Œ A=ç²‰ã€B=ç»¿ã€P=è“
  return pool === 'A' ? 'day-dot filled pink'
       : pool === 'B' ? 'day-dot filled green'
       : 'day-dot filled blue';
}
poolThresholds = JSON.parse(localStorage.getItem('poolThresholds')||'null') || { A:48, B:34 };
function saveThresholds(){
  const a = +document.getElementById('thA').value || 0;
  const b = +document.getElementById('thB').value || 0;
  poolThresholds = {A:a, B:b};
  localStorage.setItem('poolThresholds', JSON.stringify(poolThresholds));
}
function loadThresholdInputs(){
  const ta = document.getElementById('thA'), tb = document.getElementById('thB');
  if(ta) ta.value = poolThresholds.A;
  if(tb) tb.value = poolThresholds.B;
}

/* è¦†ç›–ä½ çš„ updatePoolByTodayScoreï¼Œä½¿å…¶ä½¿ç”¨é˜ˆå€¼ */
// --- è¿™æ˜¯å…¨æ–°çš„ã€æ›´æ™ºèƒ½çš„å‡½æ•° ---
function updatePoolForDate(y, m, d) {
  // å¦‚æœæ²¡æœ‰æŒ‡å®šæ—¥æœŸï¼Œå°±é»˜è®¤ä½¿ç”¨ç°å®ä¸­çš„ä»Šå¤©
  const year = y || curYear;
  const month = m || curMonth;
  const day = d || curDay;
  
  // è·å–æŒ‡å®šæ—¥æœŸçš„åˆ†æ•°
  const score = punchLog[year]?.[month]?.[day]?.score || 0;

  // æ ¹æ®åˆ†æ•°å†³å®šå¡æ± ç±»å‹
  if (score >= (poolThresholds?.A ?? 48))      poolType = 'A';
  else if (score >= (poolThresholds?.B ?? 34)) poolType = 'B';
  else                                         poolType = 'P';

  // é‡æ–°æ¸²æŸ“å¡ç‰‡ï¼Œä»¥æ˜¾ç¤ºæ­£ç¡®çš„å¡æ± 
  renderCards();
}
/* ========= å¯¼å…¥ / å¯¼å‡ºï¼ˆå¸¦å¯†ç æ ¡éªŒï¼‰ ========= */
ioPasswordHash = localStorage.getItem('ioPasswordHash') || '';

async function hashText(t){
  const enc = new TextEncoder().encode(t);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function setIoPassword(){
  const pwd = document.getElementById('pwdInput').value;
  if(!pwd){ alert('è¯·è¾“å…¥å¯†ç '); return; }
  ioPasswordHash = await hashText(pwd);
  localStorage.setItem('ioPasswordHash', ioPasswordHash);
  alert('å¯†ç å·²ä¿å­˜');
  document.getElementById('pwdInput').value='';
}
async function checkPasswordPopup(){
  // å¼¹çª—è¾“å…¥ï¼Œæ ¡éªŒhash
  const pwd = prompt('è¯·è¾“å…¥å¯¼å…¥/å¯¼å‡ºçš„å¯†ç ï¼š');
  if(!pwd) return false;
  const h = await hashText(pwd);
  return (h === (localStorage.getItem('ioPasswordHash')||''));
}
function collectAllData() {
    // ç›´æ¥ä» localStorage è¯»å–æ‰€æœ‰æ•°æ®æ¥æ‰“åŒ…ï¼Œç¡®ä¿100%å‡†ç¡®
    return {
        punchLog:       JSON.parse(localStorage.getItem('isla_punchLog') || '{}'),
        punchItems:     JSON.parse(localStorage.getItem('punchItems') || '[]'),
        visibleItems:   JSON.parse(localStorage.getItem('visibleItems') || '[]'),
        poolData:       JSON.parse(localStorage.getItem('poolData') || '{}'),
        poolThresholds: JSON.parse(localStorage.getItem('poolThresholds') || '{}'),
        theme:          JSON.parse(localStorage.getItem('theme') || 'null'),
        emojiList: JSON.parse(localStorage.getItem('emojiList') || '[]'),
        ioPasswordHash: localStorage.getItem('ioPasswordHash') || '',
        drawHistory:    JSON.parse(localStorage.getItem('drawHistory') || '{}')
    };
}
async function exportAll(){
  if (ioPasswordHash) {
    const ok = await checkPasswordPopup();
    if (!ok){ alert('å¯†ç é”™è¯¯'); return; }
  }

  const data = collectAllData();
  const json = JSON.stringify(data, null, 2);

  // â‘  å°è¯•æ–° APIï¼ˆSafari 16.4+ã€æ¡Œé¢ Chrome/Edge ç­‰æ”¯æŒï¼‰
  try {
    if (window.showSaveFilePicker) {
      const handle = await window.showSaveFilePicker({
        suggestedName: 'isla-health-export.json',
        types: [{ description: 'JSON æ–‡ä»¶', accept: {'application/json': ['.json']} }]
      });
      const writable = await handle.createWritable();
      await writable.write(new Blob([json], {type:'application/json'}));
      await writable.close();
      alert('å·²å¯¼å‡ºåˆ°æ–‡ä»¶ã€‚');
      return;
    }
  } catch(e) {
    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­èµ°ä¸‹ä¸€å¥—
  }

  // â‘¡ å¸¸è§„ Blob + a.clickï¼ˆéƒ¨åˆ† iOS WebView ä»å¯èƒ½è¢«æ‹¦ï¼‰
  try {
    const blob = new Blob([json], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'isla-health-export.json';
    a.target = '_blank';          // iOS æœ‰æ—¶éœ€è¦æ–°çª—å£
    a.rel = 'noopener';
    document.body.appendChild(a); // å¿…é¡»æ’å…¥ DOM
    a.click();
    document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
    return;
  } catch(e) {
    // ç»§ç»­å›é€€
  }

  // â‘¢ ç»ˆæå›é€€ï¼šæ‰“å¼€æ–°é¡µæ˜¾ç¤º JSONï¼Œæ‰‹åŠ¨â€œåˆ†äº«/ä¿å­˜åˆ°æ–‡ä»¶â€
  try {
    const dataUrl = 'data:application/json;charset=utf-8,' + encodeURIComponent(json);
    window.open(dataUrl, '_blank');
    alert('å·²åœ¨æ–°é¡µé¢æ‰“å¼€æ•°æ®ï¼Œè¯·ä½¿ç”¨â€œåˆ†äº«/ä¿å­˜åˆ°æ–‡ä»¶â€ã€‚');
  } catch(e) {
    alert('å¯¼å‡ºå¤±è´¥ï¼Œå¯å°è¯•ç‚¹å‡»â€œå¤åˆ¶æ•°æ®â€åè‡ªè¡Œç²˜è´´åˆ°å¤‡å¿˜å½•ä¿å­˜ã€‚');
  }
}

// å…œåº•ï¼šå¤åˆ¶åˆ°å‰ªè´´æ¿
async function copyAll(){
  const json = JSON.stringify(collectAllData(), null, 2);
  try{
    await navigator.clipboard.writeText(json);
    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
  }catch(e){
    // æŸäº› iOS éœ€ç”¨æˆ·æ“ä½œç¯å¢ƒï¼›å†æ¥ä¸ªæ—§å¼ textarea å›é€€
    const ta = document.createElement('textarea');
    ta.value = json;
    document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
  }
}
// ã€æœ€ç»ˆå®Œç¾ç‰ˆã€‘æ¸…é™¤æ‰€æœ‰æ•°æ®
function clearAllData() {
  const message = 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\nè¿™å°†åˆ é™¤åŒ…å«ä»¥ä¸‹å†…å®¹çš„æ‰€æœ‰ä¿¡æ¯ï¼š\nâ€¢ æ‰“å¡è®°å½•\nâ€¢ æ‰“å¡é¡¹ç›®\nâ€¢ æŠ½å¡å†å²\nâ€¢ å¥–æ± å†…å®¹ (å«å¼¹å¹•/ç‰¹æ•ˆ)\nâ€¢ è‡ªå®šä¹‰ä¸»é¢˜/é¢œè‰²\nâ€¢ Emojiåˆ—è¡¨\nâ€¢ å¯¼å…¥/å¯¼å‡ºå¯†ç \n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ï¼';
  if (confirm(message)) {
    // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼Œé€ä¸€æ¸…ç©ºï¼Œè€Œä¸æ˜¯ localStorage.clear()
    localStorage.setItem('isla_punchLog', '{}');
    localStorage.setItem('punchItems', '[]');
    localStorage.setItem('visibleItems', '[]');
    localStorage.setItem('poolData', '{}');
    localStorage.setItem('poolThresholds', '{}');
    localStorage.setItem('theme', '{}');
    localStorage.setItem('emojiList', '[]');
    localStorage.setItem('ioPasswordHash', '');
    localStorage.setItem('drawHistory', '{}'); // <-- ç¡®ä¿ä¹Ÿæ¸…ç©ºäº†æŠ½å¡å†å²

    alert('æ•°æ®å·²æ¸…ç©ºï¼é¡µé¢å³å°†åˆ·æ–°ã€‚');
    setTimeout(() => { location.reload(); }, 800);
  }
}
// å¯¼å…¥
// ã€æœ€ç»ˆå®Œç¾ç‰ˆã€‘
async function importFromClipboard() {
    if (localStorage.getItem('ioPasswordHash')){
       const pwd = prompt('è¯·è¾“å…¥å¯¼å…¥/å¯¼å‡ºçš„å¯†ç ï¼š');
        if(!pwd) return;
        const h = await hashText(pwd);
        if (h !== localStorage.getItem('ioPasswordHash')) {
            alert('å¯†ç é”™è¯¯');
            return;
        }
    }
    let txt = '';
    try { txt = await navigator.clipboard.readText(); } catch(e) { txt = prompt('è¯·ç²˜è´´å¯¼å‡ºçš„ JSON æ–‡æœ¬ï¼š'); }
    if (!txt) return;
    let obj;
    try { obj = JSON.parse(txt); } catch(e) { alert('ç²˜è´´å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON'); return; }

    // åŒæ ·ï¼Œå°†æ‰€æœ‰æ•°æ®å†™å…¥ localStorage
    if (obj.punchLog) localStorage.setItem('isla_punchLog', JSON.stringify(obj.punchLog));
    if (obj.punchItems) localStorage.setItem('punchItems', JSON.stringify(obj.punchItems));
    if (obj.visibleItems) localStorage.setItem('visibleItems', JSON.stringify(obj.visibleItems));
    if (obj.poolData) localStorage.setItem('poolData', JSON.stringify(obj.poolData));
    if (obj.poolThresholds) localStorage.setItem('poolThresholds', JSON.stringify(obj.poolThresholds));
    if (obj.theme) localStorage.setItem('theme', JSON.stringify(obj.theme));
    if (obj.drawHistory) localStorage.setItem('drawHistory', JSON.stringify(obj.drawHistory));
    if (obj.ioPasswordHash) localStorage.setItem('ioPasswordHash', obj.ioPasswordHash);

    // --- è¿™æ˜¯æ–°çš„ã€æ­£ç¡®çš„ä»£ç  ---
if (obj.emojiList && Array.isArray(obj.emojiList)) {
    localStorage.setItem('emojiList', JSON.stringify(obj.emojiList));
}
    
    // å¼ºåˆ¶åˆ·æ–°é¡µé¢
    alert('å¯¼å…¥å®Œæˆï¼é¡µé¢å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚');
    setTimeout(() => { location.reload(); }, 800);
}

// ã€æœ€ç»ˆå®Œç¾ç‰ˆã€‘
async function importAll() {
    if (localStorage.getItem('ioPasswordHash')){
        const pwd = prompt('è¯·è¾“å…¥å¯¼å…¥/å¯¼å‡ºçš„å¯†ç ï¼š');
        if(!pwd) return;
        const h = await hashText(pwd);
        if (h !== localStorage.getItem('ioPasswordHash')) {
            alert('å¯†ç é”™è¯¯');
            return;
        }
    }
    const f = document.getElementById('importFile').files[0];
    if (!f) { alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }
    const txt = await f.text();
    let obj;
    try { obj = JSON.parse(txt); } catch(e) { alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®'); return; }

    // å°†å¤‡ä»½æ–‡ä»¶ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œé€ä¸€å†™å…¥ localStorage
    if (obj.punchLog) localStorage.setItem('isla_punchLog', JSON.stringify(obj.punchLog));
    if (obj.punchItems) localStorage.setItem('punchItems', JSON.stringify(obj.punchItems));
    if (obj.visibleItems) localStorage.setItem('visibleItems', JSON.stringify(obj.visibleItems));
    if (obj.poolData) localStorage.setItem('poolData', JSON.stringify(obj.poolData));
    if (obj.poolThresholds) localStorage.setItem('poolThresholds', JSON.stringify(obj.poolThresholds));
    if (obj.theme) localStorage.setItem('theme', JSON.stringify(obj.theme));
    if (obj.drawHistory) localStorage.setItem('drawHistory', JSON.stringify(obj.drawHistory));
    if (obj.ioPasswordHash) localStorage.setItem('ioPasswordHash', obj.ioPasswordHash);
    
    // --- è¿™æ˜¯æ–°çš„ã€æ­£ç¡®çš„ä»£ç  ---
if (obj.emojiList && Array.isArray(obj.emojiList)) {
    localStorage.setItem('emojiList', JSON.stringify(obj.emojiList));
}
    
    // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œä»ç¡¬ç›˜é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
    alert('å¯¼å…¥å®Œæˆï¼é¡µé¢å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚');
    setTimeout(() => { location.reload(); }, 800);
}

// ã€å…¨æ–°ã€‘ä¸€ä¸ªç”¨äºåˆ·æ–°æ‰€æœ‰UIçš„è¾…åŠ©å‡½æ•°
function renderAllTabs() {
    loadThresholdInputs();
    renderItemSettings();
    renderPoolList();
    applyTheme();
    renderCalendarPage();
}

// ===== é¡µé¢åˆå§‹åŒ–ï¼ˆå”¯ä¸€ï¼‰=====
document.addEventListener('DOMContentLoaded', function () {
  // ç»‘å®š TabBar ç‚¹å‡»
  document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> switchTab(btn.dataset.tab));
});

  // ä¸»é¢˜ / è‰²å½© / é˜ˆå€¼åˆå§‹åŒ–
  try{
    applyTheme();
	  renderColorList();
    loadThresholdInputs();

    // æ£€æŸ¥ä¸»é¢˜æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”ç¼ºå°‘ cardBacks å±æ€§
    if (theme && !theme.cardBacks) {
        console.log("æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬ä¸»é¢˜æ•°æ®ï¼Œæ­£åœ¨æ‰§è¡Œä¸€æ¬¡æ€§è¿ç§»...");
        // ä¸ºæ—§æ•°æ®æ·»åŠ é»˜è®¤çš„å¡èƒŒé“¾æ¥
        theme.cardBacks = {
            A: '',
    			B: '',
    			P: ''
        };
        // å°†ä¿®å¤åçš„æ•°æ®å­˜å›æœ¬åœ°
        localStorage.setItem('theme', JSON.stringify(theme));
        // é‡æ–°æ¸²æŸ“è‰²å½©åˆ—è¡¨ï¼Œè®©æ–°çš„è¾“å…¥æ¡†æ˜¾ç¤ºå‡ºæ¥
        renderColorList(); 
    }
  } catch(e) {
      console.error("Error during theme initialization:", e);
  }

  // === ç”¨ä¸€ä¸ªæ–°çš„ try...catch åŒ…è£¹è¿™é‡Œçš„é€»è¾‘ ===
  try {
    const actOnce = getActiveItems();
    if(!Array.isArray(visibleItems) || visibleItems.length > actOnce.length){
      visibleItems = actOnce.map((_,i)=>i);
      localStorage.setItem('visibleItems', JSON.stringify(visibleItems));
    }
  } catch(e) {
      console.error("Error during visible items check:", e);
  }

  // â€œæˆ‘â€Tabé‡Œç”¨åˆ°çš„æ¸²æŸ“å…ˆå‡†å¤‡ä¸€ä¸‹ï¼ˆå¯é€‰ï¼‰
  if (typeof renderItemSettings === 'function') renderItemSettings();
  if (typeof renderPoolList === 'function') renderPoolList();

  // é»˜è®¤è¿›å…¥æ—¥å†
  switchTab('calendar');
});

</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(registration => {
        console.log('SW registered: ', registration);
      }).catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
    });
  }
</script>
</body>
</html>